<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’±åŒ…è¿æ¥è°ƒè¯•å·¥å…·</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #f0f0f0; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é’±åŒ…è¿æ¥è¯Šæ–­å·¥å…·</h1>
        
        <div class="status info">
            <h3>ç¯å¢ƒæ£€æµ‹</h3>
            <p>æµè§ˆå™¨: <span id="browser"></span></p>
            <p>MetaMask: <span id="metamask-status"></span></p>
            <p>å½“å‰ç½‘ç»œ: <span id="current-network"></span></p>
        </div>

        <div class="controls">
            <button id="detect-btn">ğŸ” æ£€æµ‹é’±åŒ…</button>
            <button id="connect-btn" disabled>ğŸ”— è¿æ¥é’±åŒ…</button>
            <button id="switch-network-btn" disabled>ğŸ”„ åˆ‡æ¢åˆ°Monadæµ‹è¯•ç½‘</button>
            <button id="clear-log-btn">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="status" id="connection-status">
            <h3>è¿æ¥çŠ¶æ€</h3>
            <p>è´¦æˆ·: <span id="account">æœªè¿æ¥</span></p>
            <p>ç½‘ç»œID: <span id="chain-id">æœªçŸ¥</span></p>
            <p>ä½™é¢: <span id="balance">-</span></p>
        </div>

        <h3>å®æ—¶æ—¥å¿—</h3>
        <div id="log"></div>
    </div>

    <script>
        const log = document.getElementById('log');
        const browserSpan = document.getElementById('browser');
        const metamaskStatus = document.getElementById('metamask-status');
        const currentNetwork = document.getElementById('current-network');
        const accountSpan = document.getElementById('account');
        const chainIdSpan = document.getElementById('chain-id');
        const balanceSpan = document.getElementById('balance');
        const connectionStatus = document.getElementById('connection-status');

        const detectBtn = document.getElementById('detect-btn');
        const connectBtn = document.getElementById('connect-btn');
        const switchNetworkBtn = document.getElementById('switch-network-btn');
        const clearLogBtn = document.getElementById('clear-log-btn');

        let ethereum = null;

        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            log.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(`[WALLET DEBUG] ${message}`);
        }

        function updateStatus(type) {
            connectionStatus.className = `status ${type}`;
        }

        // æ£€æµ‹æµè§ˆå™¨
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'Unknown';
        }

        // æ£€æµ‹é’±åŒ…
        async function detectWallet() {
            logMessage('å¼€å§‹é’±åŒ…æ£€æµ‹...');
            
            browserSpan.textContent = detectBrowser();
            
            if (typeof window === 'undefined') {
                logMessage('é”™è¯¯: ä¸åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­', 'error');
                return false;
            }

            ethereum = window.ethereum;
            logMessage(`Window.ethereum å­˜åœ¨: ${!!ethereum}`);
            
            if (!ethereum) {
                metamaskStatus.textContent = 'âŒ æœªå®‰è£…';
                metamaskStatus.style.color = 'red';
                logMessage('MetaMaskæœªæ£€æµ‹åˆ°ï¼Œè¯·å®‰è£…MetaMaskæ‰©å±•', 'error');
                return false;
            }

            metamaskStatus.textContent = 'âœ… å·²å®‰è£…';
            metamaskStatus.style.color = 'green';
            
            logMessage(`MetaMaskç‰ˆæœ¬: ${ethereum.version || 'æœªçŸ¥'}`);
            logMessage(`æ˜¯å¦ä¸ºMetaMask: ${ethereum.isMetaMask}`);
            logMessage(`æä¾›å•†: ${ethereum.constructor.name}`);

            // æ£€æµ‹å½“å‰ç½‘ç»œ
            try {
                const chainId = await ethereum.request({ method: 'eth_chainId' });
                const networkId = parseInt(chainId, 16);
                currentNetwork.textContent = `${networkId} (0x${networkId.toString(16)})`;
                logMessage(`å½“å‰ç½‘ç»œID: ${networkId}`);
            } catch (error) {
                logMessage(`è·å–ç½‘ç»œIDå¤±è´¥: ${error.message}`, 'error');
            }

            // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
            try {
                const accounts = await ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    accountSpan.textContent = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                    chainIdSpan.textContent = await ethereum.request({ method: 'eth_chainId' });
                    updateStatus('success');
                    logMessage('é’±åŒ…å·²è¿æ¥', 'success');
                    connectBtn.textContent = 'ğŸ”“ æ–­å¼€è¿æ¥';
                    switchNetworkBtn.disabled = false;
                } else {
                    updateStatus('info');
                    connectBtn.disabled = false;
                }
            } catch (error) {
                logMessage(`æ£€æŸ¥è¿æ¥çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
                updateStatus('error');
            }

            return true;
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            if (!ethereum) {
                logMessage('MetaMaskæœªæ£€æµ‹åˆ°', 'error');
                return;
            }

            logMessage('å¼€å§‹è¿æ¥é’±åŒ…...');
            
            try {
                // å°è¯•è¿æ¥
                const accounts = await ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                logMessage(`æˆåŠŸè·å–è´¦æˆ·: ${accounts.length}ä¸ª`, 'success');
                accounts.forEach((account, index) => {
                    logMessage(`è´¦æˆ·${index + 1}: ${account}`);
                });

                if (accounts.length > 0) {
                    accountSpan.textContent = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                    
                    const chainId = await ethereum.request({ method: 'eth_chainId' });
                    chainIdSpan.textContent = chainId;
                    
                    try {
                        const balance = await ethereum.request({
                            method: 'eth_getBalance',
                            params: [accounts[0], 'latest']
                        });
                        const balanceInEth = parseInt(balance, 16) / Math.pow(10, 18);
                        balanceSpan.textContent = `${balanceInEth.toFixed(4)} ETH`;
                    } catch (balError) {
                        logMessage(`è·å–ä½™é¢å¤±è´¥: ${balError.message}`, 'error');
                    }

                    updateStatus('success');
                    connectBtn.textContent = 'ğŸ”“ æ–­å¼€è¿æ¥';
                    switchNetworkBtn.disabled = false;
                    logMessage('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                }
            } catch (error) {
                logMessage(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                logMessage(`é”™è¯¯ä»£ç : ${error.code}`);
                updateStatus('error');
                
                // è¯¦ç»†é”™è¯¯åˆ†æ
                if (error.code === 4001) {
                    logMessage('ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚', 'error');
                } else if (error.code === -32002) {
                    logMessage('è¿æ¥è¯·æ±‚å·²åœ¨å¤„ç†ä¸­ï¼Œè¯·æ£€æŸ¥MetaMaskå¼¹çª—', 'error');
                } else if (error.code === -32603) {
                    logMessage('å†…éƒ¨é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                }
            }
        }

        // åˆ‡æ¢ç½‘ç»œ
        async function switchToMonadTestnet() {
            if (!ethereum) return;
            
            const MONAD_CHAIN_ID = '0x279F'; // 10143 in hex
            
            logMessage('å°è¯•åˆ‡æ¢åˆ°Monadæµ‹è¯•ç½‘...');
            
            try {
                await ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: MONAD_CHAIN_ID }],
                });
                logMessage('æˆåŠŸåˆ‡æ¢åˆ°Monadæµ‹è¯•ç½‘', 'success');
            } catch (switchError) {
                if (switchError.code === 4902) {
                    logMessage('ç½‘ç»œæœªæ·»åŠ ï¼Œå°è¯•æ·»åŠ Monadæµ‹è¯•ç½‘...');
                    try {
                        await ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: MONAD_CHAIN_ID,
                                chainName: 'Monad Testnet',
                                nativeCurrency: {
                                    name: 'MON',
                                    symbol: 'MON',
                                    decimals: 18,
                                },
                                rpcUrls: ['https://testnet-rpc.monad.xyz'],
                                blockExplorerUrls: ['https://testnet-explorer.monad.xyz'],
                            }],
                        });
                        logMessage('æˆåŠŸæ·»åŠ å¹¶åˆ‡æ¢åˆ°Monadæµ‹è¯•ç½‘', 'success');
                    } catch (addError) {
                        logMessage(`æ·»åŠ ç½‘ç»œå¤±è´¥: ${addError.message}`, 'error');
                    }
                } else {
                    logMessage(`åˆ‡æ¢ç½‘ç»œå¤±è´¥: ${switchError.message}`, 'error');
                }
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnectWallet() {
            accountSpan.textContent = 'æœªè¿æ¥';
            chainIdSpan.textContent = 'æœªçŸ¥';
            balanceSpan.textContent = '-';
            updateStatus('info');
            connectBtn.textContent = 'ğŸ”— è¿æ¥é’±åŒ…';
            switchNetworkBtn.disabled = true;
            logMessage('é’±åŒ…å·²æ–­å¼€', 'info');
        }

        // äº‹ä»¶ç›‘å¬å™¨
        detectBtn.addEventListener('click', detectWallet);
        
        connectBtn.addEventListener('click', () => {
            if (connectBtn.textContent.includes('æ–­å¼€')) {
                disconnectWallet();
            } else {
                connectWallet();
            }
        });
        
        switchNetworkBtn.addEventListener('click', switchToMonadTestnet);
        
        clearLogBtn.addEventListener('click', () => {
            log.textContent = '';
            logMessage('æ—¥å¿—å·²æ¸…ç©º');
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.addEventListener('load', () => {
            logMessage('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            detectWallet();
        });

        // MetaMaskäº‹ä»¶ç›‘å¬
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                logMessage(`è´¦æˆ·å˜æ›´: ${accounts.length > 0 ? accounts[0] : 'æ— è´¦æˆ·'}`);
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    accountSpan.textContent = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                logMessage(`ç½‘ç»œå˜æ›´: ${parseInt(chainId, 16)}`);
                chainIdSpan.textContent = chainId;
                window.location.reload(); // æ¨èé‡æ–°åŠ è½½é¡µé¢
            });
        }

        logMessage('é’±åŒ…è°ƒè¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>