<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’±åŒ…è¿æ¥ä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f8ff;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #2196F3;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 5px; }
        .success { color: #388e3c; background: #e8f5e8; padding: 10px; border-radius: 5px; }
        .warning { color: #f57c00; background: #fff3e0; padding: 10px; border-radius: 5px; }
        .info { color: #1976d2; background: #e3f2fd; padding: 10px; border-radius: 5px; }
        h1 { color: #1976d2; text-align: center; }
        h2 { color: #333; margin-top: 0; }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .connected { background: #4CAF50; color: white; }
        .disconnected { background: #f44336; color: white; }
        .wrong-network { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ”§ é’±åŒ…è¿æ¥ä¿®å¤å·¥å…·</h1>
    
    <div class="card">
        <h2>ğŸ” å½“å‰çŠ¶æ€æ£€æŸ¥</h2>
        <p>é’±åŒ…çŠ¶æ€: <span id="wallet-status">æ£€æµ‹ä¸­...</span></p>
        <p>ç½‘ç»œçŠ¶æ€: <span id="network-status">æ£€æµ‹ä¸­...</span></p>
        <p>è´¦æˆ·åœ°å€: <span id="account-display">æœªè¿æ¥</span></p>
        <button onclick="checkStatus()">é‡æ–°æ£€æµ‹</button>
    </div>

    <div class="card">
        <h2>ğŸš€ å¿«é€Ÿä¿®å¤</h2>
        <div class="info">
            <strong>å¸¸è§é—®é¢˜è‡ªåŠ¨ä¿®å¤ï¼š</strong>
        </div>
        <button onclick="quickConnect()">ä¸€é”®è¿æ¥é’±åŒ…</button>
        <button onclick="switchNetwork()">åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘</button>
        <button onclick="resetConnection()">é‡ç½®è¿æ¥</button>
        <div id="fix-result"></div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ è¯¦ç»†è¯Šæ–­</h2>
        <div id="diagnostic-details"></div>
        <button onclick="runFullDiagnostic()">å®Œæ•´è¯Šæ–­</button>
    </div>

    <div class="card">
        <h2>ğŸ›  æ‰‹åŠ¨è§£å†³æ–¹æ¡ˆ</h2>
        <div class="warning">
            <strong>å¦‚æœè‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œè¯·å°è¯•ä»¥ä¸‹æ­¥éª¤ï¼š</strong>
            <ol>
                <li>ç¡®ä¿å·²å®‰è£… MetaMask æµè§ˆå™¨æ‰©å±•</li>
                <li>åˆ·æ–°é¡µé¢å¹¶é‡æ–°è¿æ¥</li>
                <li>åœ¨ MetaMask ä¸­æ‰‹åŠ¨æ·»åŠ  Monad æµ‹è¯•ç½‘</li>
                <li>æ£€æŸ¥ MetaMask æ˜¯å¦è¢«å…¶ä»–åº”ç”¨é”å®š</li>
                <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶é‡è¯•</li>
            </ol>
        </div>
        <button onclick="openMetaMask()">æ‰“å¼€ MetaMask</button>
        <button onclick="copyNetworkConfig()">å¤åˆ¶ç½‘ç»œé…ç½®</button>
    </div>

    <script>
        const MONAD_TESTNET = {
            chainId: '0xa1f6', // 41454
            chainName: 'Monad Testnet',
            nativeCurrency: {
                name: 'MON',
                symbol: 'MON',
                decimals: 18
            },
            rpcUrls: ['https://testnet-rpc.monad.xyz'],
            blockExplorerUrls: ['https://testnet-explorer.monad.xyz']
        };

        let currentAccount = null;
        let currentChainId = null;

        function updateStatus(walletMsg, networkMsg, account = null) {
            document.getElementById('wallet-status').innerHTML = walletMsg;
            document.getElementById('network-status').innerHTML = networkMsg;
            if (account) {
                document.getElementById('account-display').textContent = 
                    `${account.slice(0, 6)}...${account.slice(-4)}`;
            }
        }

        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('fix-result');
            resultDiv.innerHTML = `<div class="${type}" style="margin-top: 15px;">${message}</div>`;
        }

        async function checkStatus() {
            console.log('å¼€å§‹çŠ¶æ€æ£€æŸ¥...');
            
            if (!window.ethereum) {
                updateStatus(
                    'âŒ æœªæ£€æµ‹åˆ°é’±åŒ… <span class="status-badge disconnected">æœªå®‰è£…</span>',
                    'âš ï¸ æ— æ³•æ£€æµ‹ç½‘ç»œ'
                );
                return;
            }

            try {
                // æ£€æŸ¥è¿æ¥çŠ¶æ€
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                currentAccount = accounts[0] || null;
                currentChainId = parseInt(chainId, 16);

                if (currentAccount) {
                    updateStatus(
                        'âœ… é’±åŒ…å·²è¿æ¥ <span class="status-badge connected">å·²è¿æ¥</span>',
                        currentChainId === 41454 
                            ? 'âœ… Monad æµ‹è¯•ç½‘ <span class="status-badge connected">æ­£ç¡®ç½‘ç»œ</span>'
                            : `âš ï¸ é”™è¯¯ç½‘ç»œ (${currentChainId}) <span class="status-badge wrong-network">éœ€åˆ‡æ¢</span>`,
                        currentAccount
                    );
                } else {
                    updateStatus(
                        'âš ï¸ é’±åŒ…æœªè¿æ¥ <span class="status-badge disconnected">æœªè¿æ¥</span>',
                        'âš ï¸ éœ€è¦å…ˆè¿æ¥é’±åŒ…'
                    );
                }
            } catch (error) {
                updateStatus(
                    'âŒ é’±åŒ…æ£€æµ‹å¤±è´¥ <span class="status-badge disconnected">é”™è¯¯</span>',
                    `âŒ é”™è¯¯: ${error.message}`
                );
            }
        }

        async function quickConnect() {
            console.log('å¼€å§‹å¿«é€Ÿè¿æ¥...');
            showResult('æ­£åœ¨è¿æ¥é’±åŒ…...', 'info');

            try {
                if (!window.ethereum) {
                    throw new Error('æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å…ˆå®‰è£…');
                }

                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                if (accounts.length === 0) {
                    throw new Error('ç”¨æˆ·æ‹’ç»è¿æ¥');
                }

                currentAccount = accounts[0];
                showResult(`âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼åœ°å€: ${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`, 'success');
                
                // è‡ªåŠ¨æ£€æŸ¥ç½‘ç»œ
                await checkStatus();
                
                // å¦‚æœä¸åœ¨æ­£ç¡®ç½‘ç»œï¼Œæç¤ºåˆ‡æ¢
                if (currentChainId !== 41454) {
                    showResult('âš ï¸ é’±åŒ…å·²è¿æ¥ï¼Œä½†éœ€è¦åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘', 'warning');
                }

            } catch (error) {
                showResult(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function switchNetwork() {
            console.log('å¼€å§‹åˆ‡æ¢ç½‘ç»œ...');
            showResult('æ­£åœ¨åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘...', 'info');

            try {
                if (!window.ethereum) {
                    throw new Error('æœªæ£€æµ‹åˆ°é’±åŒ…');
                }

                // å°è¯•åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: MONAD_TESTNET.chainId }]
                });

                showResult('âœ… æˆåŠŸåˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘ï¼', 'success');
                await checkStatus();

            } catch (switchError) {
                console.log('åˆ‡æ¢å¤±è´¥ï¼Œå°è¯•æ·»åŠ ç½‘ç»œ...', switchError);
                
                if (switchError.code === 4902) {
                    try {
                        // ç½‘ç»œä¸å­˜åœ¨ï¼Œå°è¯•æ·»åŠ 
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [MONAD_TESTNET]
                        });
                        showResult('âœ… æˆåŠŸæ·»åŠ å¹¶åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘ï¼', 'success');
                        await checkStatus();
                    } catch (addError) {
                        showResult(`âŒ æ·»åŠ ç½‘ç»œå¤±è´¥: ${addError.message}`, 'error');
                    }
                } else {
                    showResult(`âŒ åˆ‡æ¢ç½‘ç»œå¤±è´¥: ${switchError.message}`, 'error');
                }
            }
        }

        async function resetConnection() {
            console.log('é‡ç½®è¿æ¥...');
            showResult('æ­£åœ¨é‡ç½®è¿æ¥...', 'info');

            try {
                // æ¸…é™¤å½“å‰çŠ¶æ€
                currentAccount = null;
                currentChainId = null;
                
                // é‡æ–°æ£€æŸ¥çŠ¶æ€
                await checkStatus();
                
                showResult('âœ… è¿æ¥å·²é‡ç½®ï¼Œè¯·é‡æ–°è¿æ¥é’±åŒ…', 'success');
            } catch (error) {
                showResult(`âŒ é‡ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function runFullDiagnostic() {
            const detailsDiv = document.getElementById('diagnostic-details');
            let diagnostic = '<h3>ğŸ“Š è¯Šæ–­æŠ¥å‘Š</h3>';

            // åŸºç¡€ç¯å¢ƒæ£€æŸ¥
            diagnostic += '<h4>ğŸ”§ ç¯å¢ƒæ£€æŸ¥</h4>';
            diagnostic += `<p>â€¢ æµè§ˆå™¨: ${navigator.userAgent}</p>`;
            diagnostic += `<p>â€¢ Ethereum å¯¹è±¡: ${!!window.ethereum ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</p>`;
            diagnostic += `<p>â€¢ MetaMask: ${window.ethereum?.isMetaMask ? 'âœ… å·²å®‰è£…' : 'âŒ æœªå®‰è£…'}</p>`;
            diagnostic += `<p>â€¢ ç½‘ç»œçŠ¶æ€: ${navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}</p>`;

            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    
                    diagnostic += '<h4>ğŸ”— è¿æ¥çŠ¶æ€</h4>';
                    diagnostic += `<p>â€¢ è¿æ¥è´¦æˆ·æ•°: ${accounts.length}</p>`;
                    diagnostic += `<p>â€¢ å½“å‰è´¦æˆ·: ${accounts[0] || 'æ— '}</p>`;
                    diagnostic += `<p>â€¢ å½“å‰é“¾ID: ${parseInt(chainId, 16)} (0x${parseInt(chainId, 16).toString(16)})</p>`;
                    diagnostic += `<p>â€¢ ç›®æ ‡é“¾ID: 41454 (0xa1f6)</p>`;
                    diagnostic += `<p>â€¢ ç½‘ç»œåŒ¹é…: ${parseInt(chainId, 16) === 41454 ? 'âœ… æ­£ç¡®' : 'âŒ éœ€è¦åˆ‡æ¢'}</p>`;
                } catch (error) {
                    diagnostic += `<p class="error">è·å–é’±åŒ…ä¿¡æ¯å¤±è´¥: ${error.message}</p>`;
                }
            }

            detailsDiv.innerHTML = diagnostic;
        }

        function openMetaMask() {
            if (window.ethereum) {
                window.ethereum.request({ method: 'wallet_requestPermissions', params: [{ eth_accounts: {} }] });
            } else {
                window.open('https://metamask.io/download.html', '_blank');
            }
        }

        function copyNetworkConfig() {
            const config = `
ç½‘ç»œåç§°: ${MONAD_TESTNET.chainName}
é“¾ID: 41454
RPC URL: ${MONAD_TESTNET.rpcUrls[0]}
è´§å¸ç¬¦å·: ${MONAD_TESTNET.nativeCurrency.symbol}
åŒºå—æµè§ˆå™¨: ${MONAD_TESTNET.blockExplorerUrls[0]}
            `.trim();
            
            navigator.clipboard.writeText(config).then(() => {
                showResult('âœ… ç½‘ç»œé…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showResult('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é…ç½®ä¿¡æ¯', 'error');
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', checkStatus);

        // ç›‘å¬é’±åŒ…äº‹ä»¶
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('è´¦æˆ·å˜æ›´:', accounts);
                currentAccount = accounts[0] || null;
                checkStatus();
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log('ç½‘ç»œå˜æ›´:', chainId);
                currentChainId = parseInt(chainId, 16);
                checkStatus();
            });
        }
    </script>
</body>
</html>