<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMH Web3 调试控制台</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4FC3F7;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            background: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .error-section {
            border-left-color: #f44336;
        }
        .warning-section {
            border-left-color: #ff9800;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #404040;
        }
        .config-item:last-child {
            border-bottom: none;
        }
        .status-good { color: #4CAF50; }
        .status-error { color: #f44336; }
        .status-warning { color: #ff9800; }
        .log-area {
            background: #1e1e1e;
            border: 1px solid #404040;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #81C784; }
        .log-error { color: #f44336; }
        .log-warning { color: #ffb74d; }
        .log-success { color: #4CAF50; }
        input, select {
            background: #3e3e3e;
            color: #d4d4d4;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
        }
        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .contract-test {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 3px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 FMH Web3 调试控制台</h1>
        
        <!-- 配置检查 -->
        <div class="section">
            <h2>📋 当前配置检查</h2>
            <div id="config-status">
                <div class="config-item">
                    <span>钱包连接状态</span>
                    <span id="wallet-connection">未检测</span>
                </div>
                <div class="config-item">
                    <span>当前网络 Chain ID</span>
                    <span id="current-chain">未获取</span>
                </div>
                <div class="config-item">
                    <span>目标网络 Chain ID</span>
                    <span class="status-good">10143 (Monad 测试网)</span>
                </div>
                <div class="config-item">
                    <span>FMH Token 地址</span>
                    <span id="fmh-token-addr">0xFa32A01E4FDAde90204902EDfEa63C150407C736</span>
                </div>
                <div class="config-item">
                    <span>Minesweeper 地址</span>
                    <span id="game-contract-addr">0xf25dc66782643c42F30Acf151A9E0CA01C283341</span>
                </div>
                <div class="config-item">
                    <span>RPC URL</span>
                    <span id="rpc-url">https://testnet-rpc.monad.xyz</span>
                </div>
            </div>
            <button onclick="checkConfiguration()">刷新配置检查</button>
            <button onclick="connectWallet()">连接钱包</button>
        </div>

        <!-- 网络诊断 -->
        <div class="section">
            <h2>🌐 网络连接诊断</h2>
            <div class="flex">
                <button onclick="testRpcConnection()">测试 RPC 连接</button>
                <button onclick="switchToMonadTestnet()">切换到 Monad 测试网</button>
                <button onclick="addMonadNetwork()">添加 Monad 网络</button>
            </div>
            <div id="network-test-result"></div>
        </div>

        <!-- 合约测试 -->
        <div class="section">
            <h2>📄 合约方法测试</h2>
            
            <div class="contract-test">
                <h3>FMH Token 合约测试</h3>
                <div class="flex">
                    <button onclick="testTokenContract('name')">测试 name()</button>
                    <button onclick="testTokenContract('symbol')">测试 symbol()</button>
                    <button onclick="testTokenContract('totalSupply')">测试 totalSupply()</button>
                    <button onclick="testIsOwner()">测试 isOwner()</button>
                </div>
                <div>
                    <label>测试地址: </label>
                    <input type="text" id="test-address" placeholder="输入要测试的地址" style="width: 400px;">
                    <button onclick="testTokenBalance()">查询余额</button>
                </div>
            </div>

            <div class="contract-test">
                <h3>Minesweeper 合约测试</h3>
                <div class="flex">
                    <button onclick="testGameContract('gameCounter')">测试 gameCounter()</button>
                    <button onclick="testGameContract('fmhToken')">测试 fmhToken()</button>
                    <button onclick="checkGameOwnership()">检查游戏所有权</button>
                </div>
            </div>
        </div>

        <!-- 日志区域 -->
        <div class="section">
            <h2>📝 调试日志</h2>
            <div class="flex">
                <button onclick="clearLog()">清除日志</button>
                <button onclick="exportLog()">导出日志</button>
                <button onclick="runFullDiagnostic()">完整诊断</button>
            </div>
            <div id="log-area" class="log-area"></div>
        </div>

        <!-- 快速修复 -->
        <div class="section warning-section">
            <h2>⚡ 快速修复工具</h2>
            <div class="flex">
                <button onclick="fixChainIdMismatch()">修复 Chain ID 不匹配</button>
                <button onclick="resetWeb3Connection()">重置 Web3 连接</button>
                <button onclick="refreshContractConfig()">刷新合约配置</button>
            </div>
        </div>
    </div>

    <script>
        // 配置常量
        const CONFIG = {
            MONAD_TESTNET: {
                chainId: '0x2727', // 10143 in hex
                chainIdDecimal: 10143,
                chainName: 'Monad Testnet',
                nativeCurrency: {
                    name: 'MON',
                    symbol: 'MON',
                    decimals: 18
                },
                rpcUrls: ['https://testnet-rpc.monad.xyz'],
                blockExplorerUrls: ['https://testnet-explorer.monad.xyz']
            },
            CONTRACTS: {
                FMH_TOKEN: '0xFa32A01E4FDAde90204902EDfEa63C150407C736',
                MINESWEEPER_GAME: '0xf25dc66782643c42F30Acf151A9E0CA01C283341'
            },
            FMH_TOKEN_ABI: [
                "function name() external view returns (string)",
                "function symbol() external view returns (string)",
                "function totalSupply() external view returns (uint256)",
                "function balanceOf(address account) external view returns (uint256)",
                "function isOwner(address addr) external view returns (bool)",
                "function owners(address) external view returns (bool)",
                "function authorizedMinters(address) external view returns (bool)"
            ],
            GAME_ABI: [
                "function gameCounter() external view returns (uint256)",
                "function fmhToken() external view returns (address)",
                "function owner() external view returns (address)"
            ]
        };

        let provider = null;
        let signer = null;
        let currentAccount = null;

        function log(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = \`log-entry log-\${type}\`;
            logEntry.textContent = \`[\${timestamp}] \${message}\`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-area').innerHTML = '';
            log('日志已清除', 'info');
        }

        function exportLog() {
            const logContent = document.getElementById('log-area').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = \`web3-debug-\${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt\`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function checkConfiguration() {
            log('开始配置检查...', 'info');
            
            try {
                if (!window.ethereum) {
                    document.getElementById('wallet-connection').innerHTML = '<span class="status-error">未安装 MetaMask</span>';
                    log('未检测到 MetaMask', 'error');
                    return;
                }

                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdDecimal = parseInt(chainId, 16);

                currentAccount = accounts[0] || null;
                
                // 更新显示
                if (currentAccount) {
                    document.getElementById('wallet-connection').innerHTML = \`<span class="status-good">已连接: \${currentAccount.slice(0,6)}...\${currentAccount.slice(-4)}</span>\`;
                } else {
                    document.getElementById('wallet-connection').innerHTML = '<span class="status-warning">未连接</span>';
                }

                if (chainIdDecimal === CONFIG.MONAD_TESTNET.chainIdDecimal) {
                    document.getElementById('current-chain').innerHTML = \`<span class="status-good">\${chainIdDecimal} ✓</span>\`;
                    log('网络配置正确', 'success');
                } else {
                    document.getElementById('current-chain').innerHTML = \`<span class="status-error">\${chainIdDecimal} (错误网络)</span>\`;
                    log(\`当前网络 \${chainIdDecimal} 不匹配，需要切换到 \${CONFIG.MONAD_TESTNET.chainIdDecimal}\`, 'error');
                }

                // 初始化 provider
                if (chainIdDecimal === CONFIG.MONAD_TESTNET.chainIdDecimal && currentAccount) {
                    provider = new ethers.BrowserProvider(window.ethereum, {
                        name: 'Monad Testnet',
                        chainId: 10143,
                        ensAddress: null, // 禁用 ENS 解析
                    });
                    signer = await provider.getSigner();
                    log('Web3 Provider 初始化成功', 'success');
                }

            } catch (error) {
                log(\`配置检查失败: \${error.message}\`, 'error');
            }
        }

        async function connectWallet() {
            log('开始连接钱包...', 'info');
            
            try {
                if (!window.ethereum) {
                    throw new Error('请安装 MetaMask');
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (accounts.length === 0) {
                    throw new Error('用户拒绝连接');
                }

                currentAccount = accounts[0];
                log(\`钱包连接成功: \${currentAccount}\`, 'success');
                await checkConfiguration();

            } catch (error) {
                log(\`钱包连接失败: \${error.message}\`, 'error');
            }
        }

        async function testRpcConnection() {
            log('测试 RPC 连接...', 'info');
            
            try {
                const response = await fetch(CONFIG.MONAD_TESTNET.rpcUrls[0], {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_chainId',
                        params: [],
                        id: 1
                    })
                });

                if (!response.ok) {
                    throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(\`RPC 错误: \${data.error.message}\`);
                }

                const chainId = parseInt(data.result, 16);
                log(\`RPC 连接成功! Chain ID: \${chainId}\`, 'success');
                document.getElementById('network-test-result').innerHTML = \`<span class="status-good">✓ RPC 连接正常，Chain ID: \${chainId}</span>\`;

            } catch (error) {
                log(\`RPC 连接失败: \${error.message}\`, 'error');
                document.getElementById('network-test-result').innerHTML = \`<span class="status-error">✗ RPC 连接失败: \${error.message}</span>\`;
            }
        }

        async function switchToMonadTestnet() {
            log('切换到 Monad 测试网...', 'info');
            
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CONFIG.MONAD_TESTNET.chainId }]
                });
                
                log('网络切换成功', 'success');
                setTimeout(checkConfiguration, 1000);

            } catch (error) {
                if (error.code === 4902) {
                    log('网络未添加，尝试添加...', 'warning');
                    await addMonadNetwork();
                } else {
                    log(\`网络切换失败: \${error.message}\`, 'error');
                }
            }
        }

        async function addMonadNetwork() {
            log('添加 Monad 测试网...', 'info');
            
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [CONFIG.MONAD_TESTNET]
                });
                
                log('网络添加成功', 'success');
                setTimeout(checkConfiguration, 1000);

            } catch (error) {
                log(\`网络添加失败: \${error.message}\`, 'error');
            }
        }

        async function testTokenContract(method) {
            log(\`测试 FMH Token.\${method}()...\`, 'info');
            
            try {
                if (!provider) {
                    throw new Error('请先连接钱包并确保网络正确');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.FMH_TOKEN, CONFIG.FMH_TOKEN_ABI, provider);
                const result = await contract[method]();
                
                log(\`\${method}() 调用成功: \${result}\`, 'success');

            } catch (error) {
                log(\`\${method}() 调用失败: \${error.message}\`, 'error');
            }
        }

        async function testIsOwner() {
            log('测试 isOwner() 方法...', 'info');
            
            try {
                if (!provider || !currentAccount) {
                    throw new Error('请先连接钱包');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.FMH_TOKEN, CONFIG.FMH_TOKEN_ABI, provider);
                const result = await contract.isOwner(currentAccount);
                
                log(\`isOwner(\${currentAccount}) = \${result}\`, 'success');

            } catch (error) {
                log(\`isOwner() 调用失败: \${error.message}\`, 'error');
                log('可能的原因: 1) 合约地址错误 2) ABI 不匹配 3) 网络问题', 'warning');
            }
        }

        async function testTokenBalance() {
            const address = document.getElementById('test-address').value;
            if (!address) {
                log('请输入要查询的地址', 'warning');
                return;
            }

            log(\`查询地址 \${address} 的 Token 余额...\`, 'info');
            
            try {
                if (!provider) {
                    throw new Error('请先连接钱包并确保网络正确');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.FMH_TOKEN, CONFIG.FMH_TOKEN_ABI, provider);
                const balance = await contract.balanceOf(address);
                const formattedBalance = ethers.utils.formatEther(balance);
                
                log(\`地址 \${address} 的余额: \${formattedBalance} FMH\`, 'success');

            } catch (error) {
                log(\`余额查询失败: \${error.message}\`, 'error');
            }
        }

        async function testGameContract(method) {
            log(\`测试 Minesweeper.\${method}()...\`, 'info');
            
            try {
                if (!provider) {
                    throw new Error('请先连接钱包并确保网络正确');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.MINESWEEPER_GAME, CONFIG.GAME_ABI, provider);
                const result = await contract[method]();
                
                log(\`\${method}() 调用成功: \${result}\`, 'success');

            } catch (error) {
                log(\`\${method}() 调用失败: \${error.message}\`, 'error');
            }
        }

        async function checkGameOwnership() {
            log('检查游戏合约所有权...', 'info');
            
            try {
                if (!provider || !currentAccount) {
                    throw new Error('请先连接钱包');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.MINESWEEPER_GAME, CONFIG.GAME_ABI, provider);
                const owner = await contract.owner();
                
                log(\`游戏合约 Owner: \${owner}\`, 'success');
                log(\`当前账户: \${currentAccount}\`, 'info');
                log(\`是否为 Owner: \${owner.toLowerCase() === currentAccount.toLowerCase()}\`, 'info');

            } catch (error) {
                log(\`所有权检查失败: \${error.message}\`, 'error');
            }
        }

        async function runFullDiagnostic() {
            log('=== 开始完整诊断 ===', 'info');
            
            // 基础检查
            await checkConfiguration();
            await new Promise(r => setTimeout(r, 1000));
            
            // 网络测试
            await testRpcConnection();
            await new Promise(r => setTimeout(r, 1000));
            
            // 合约测试
            if (provider && currentAccount) {
                await testTokenContract('name');
                await new Promise(r => setTimeout(r, 500));
                await testTokenContract('symbol');
                await new Promise(r => setTimeout(r, 500));
                await testIsOwner();
                await new Promise(r => setTimeout(r, 500));
                await testGameContract('gameCounter');
            }
            
            log('=== 诊断完成 ===', 'success');
        }

        function fixChainIdMismatch() {
            log('修复 Chain ID 不匹配问题...', 'info');
            log('执行自动切换网络...', 'warning');
            switchToMonadTestnet();
        }

        function resetWeb3Connection() {
            log('重置 Web3 连接...', 'info');
            provider = null;
            signer = null;
            currentAccount = null;
            log('连接已重置，请重新连接钱包', 'success');
        }

        function refreshContractConfig() {
            log('刷新合约配置...', 'info');
            log(\`FMH Token: \${CONFIG.CONTRACTS.FMH_TOKEN}\`, 'info');
            log(\`Minesweeper: \${CONFIG.CONTRACTS.MINESWEEPER_GAME}\`, 'info');
            log(\`Chain ID: \${CONFIG.MONAD_TESTNET.chainIdDecimal}\`, 'info');
            checkConfiguration();
        }

        // 页面加载时自动检查
        window.addEventListener('load', () => {
            log('Web3 调试控制台已加载', 'info');
            checkConfiguration();
        });

        // 监听钱包事件
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                currentAccount = accounts[0] || null;
                log(\`账户变更: \${currentAccount || '断开连接'}\`, 'warning');
                checkConfiguration();
            });

            window.ethereum.on('chainChanged', (chainId) => {
                const chainIdDecimal = parseInt(chainId, 16);
                log(\`网络变更: \${chainIdDecimal}\`, 'warning');
                checkConfiguration();
            });
        }
    </script>
</body>
</html>