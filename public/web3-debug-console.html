<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMH Web3 è°ƒè¯•æ§åˆ¶å°</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4FC3F7;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            background: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .error-section {
            border-left-color: #f44336;
        }
        .warning-section {
            border-left-color: #ff9800;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #404040;
        }
        .config-item:last-child {
            border-bottom: none;
        }
        .status-good { color: #4CAF50; }
        .status-error { color: #f44336; }
        .status-warning { color: #ff9800; }
        .log-area {
            background: #1e1e1e;
            border: 1px solid #404040;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #81C784; }
        .log-error { color: #f44336; }
        .log-warning { color: #ffb74d; }
        .log-success { color: #4CAF50; }
        input, select {
            background: #3e3e3e;
            color: #d4d4d4;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
        }
        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .contract-test {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 3px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ FMH Web3 è°ƒè¯•æ§åˆ¶å°</h1>
        
        <!-- é…ç½®æ£€æŸ¥ -->
        <div class="section">
            <h2>ğŸ“‹ å½“å‰é…ç½®æ£€æŸ¥</h2>
            <div id="config-status">
                <div class="config-item">
                    <span>é’±åŒ…è¿æ¥çŠ¶æ€</span>
                    <span id="wallet-connection">æœªæ£€æµ‹</span>
                </div>
                <div class="config-item">
                    <span>å½“å‰ç½‘ç»œ Chain ID</span>
                    <span id="current-chain">æœªè·å–</span>
                </div>
                <div class="config-item">
                    <span>ç›®æ ‡ç½‘ç»œ Chain ID</span>
                    <span class="status-good">10143 (Monad æµ‹è¯•ç½‘)</span>
                </div>
                <div class="config-item">
                    <span>FMH Token åœ°å€</span>
                    <span id="fmh-token-addr">0xFa32A01E4FDAde90204902EDfEa63C150407C736</span>
                </div>
                <div class="config-item">
                    <span>Minesweeper åœ°å€</span>
                    <span id="game-contract-addr">0xf25dc66782643c42F30Acf151A9E0CA01C283341</span>
                </div>
                <div class="config-item">
                    <span>RPC URL</span>
                    <span id="rpc-url">https://testnet-rpc.monad.xyz</span>
                </div>
            </div>
            <button onclick="checkConfiguration()">åˆ·æ–°é…ç½®æ£€æŸ¥</button>
            <button onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
        </div>

        <!-- ç½‘ç»œè¯Šæ–­ -->
        <div class="section">
            <h2>ğŸŒ ç½‘ç»œè¿æ¥è¯Šæ–­</h2>
            <div class="flex">
                <button onclick="testRpcConnection()">æµ‹è¯• RPC è¿æ¥</button>
                <button onclick="switchToMonadTestnet()">åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘</button>
                <button onclick="addMonadNetwork()">æ·»åŠ  Monad ç½‘ç»œ</button>
            </div>
            <div id="network-test-result"></div>
        </div>

        <!-- åˆçº¦æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ“„ åˆçº¦æ–¹æ³•æµ‹è¯•</h2>
            
            <div class="contract-test">
                <h3>FMH Token åˆçº¦æµ‹è¯•</h3>
                <div class="flex">
                    <button onclick="testTokenContract('name')">æµ‹è¯• name()</button>
                    <button onclick="testTokenContract('symbol')">æµ‹è¯• symbol()</button>
                    <button onclick="testTokenContract('totalSupply')">æµ‹è¯• totalSupply()</button>
                    <button onclick="testIsOwner()">æµ‹è¯• isOwner()</button>
                </div>
                <div>
                    <label>æµ‹è¯•åœ°å€: </label>
                    <input type="text" id="test-address" placeholder="è¾“å…¥è¦æµ‹è¯•çš„åœ°å€" style="width: 400px;">
                    <button onclick="testTokenBalance()">æŸ¥è¯¢ä½™é¢</button>
                </div>
            </div>

            <div class="contract-test">
                <h3>Minesweeper åˆçº¦æµ‹è¯•</h3>
                <div class="flex">
                    <button onclick="testGameContract('gameCounter')">æµ‹è¯• gameCounter()</button>
                    <button onclick="testGameContract('fmhToken')">æµ‹è¯• fmhToken()</button>
                    <button onclick="checkGameOwnership()">æ£€æŸ¥æ¸¸æˆæ‰€æœ‰æƒ</button>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“ è°ƒè¯•æ—¥å¿—</h2>
            <div class="flex">
                <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
                <button onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
                <button onclick="runFullDiagnostic()">å®Œæ•´è¯Šæ–­</button>
            </div>
            <div id="log-area" class="log-area"></div>
        </div>

        <!-- å¿«é€Ÿä¿®å¤ -->
        <div class="section warning-section">
            <h2>âš¡ å¿«é€Ÿä¿®å¤å·¥å…·</h2>
            <div class="flex">
                <button onclick="fixChainIdMismatch()">ä¿®å¤ Chain ID ä¸åŒ¹é…</button>
                <button onclick="resetWeb3Connection()">é‡ç½® Web3 è¿æ¥</button>
                <button onclick="refreshContractConfig()">åˆ·æ–°åˆçº¦é…ç½®</button>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®å¸¸é‡
        const CONFIG = {
            MONAD_TESTNET: {
                chainId: '0x2727', // 10143 in hex
                chainIdDecimal: 10143,
                chainName: 'Monad Testnet',
                nativeCurrency: {
                    name: 'MON',
                    symbol: 'MON',
                    decimals: 18
                },
                rpcUrls: ['https://testnet-rpc.monad.xyz'],
                blockExplorerUrls: ['https://testnet-explorer.monad.xyz']
            },
            CONTRACTS: {
                FMH_TOKEN: '0xFa32A01E4FDAde90204902EDfEa63C150407C736',
                MINESWEEPER_GAME: '0xf25dc66782643c42F30Acf151A9E0CA01C283341'
            },
            FMH_TOKEN_ABI: [
                "function name() external view returns (string)",
                "function symbol() external view returns (string)",
                "function totalSupply() external view returns (uint256)",
                "function balanceOf(address account) external view returns (uint256)",
                "function isOwner(address addr) external view returns (bool)",
                "function owners(address) external view returns (bool)",
                "function authorizedMinters(address) external view returns (bool)"
            ],
            GAME_ABI: [
                "function gameCounter() external view returns (uint256)",
                "function fmhToken() external view returns (address)",
                "function owner() external view returns (address)"
            ]
        };

        let provider = null;
        let signer = null;
        let currentAccount = null;

        function log(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = \`log-entry log-\${type}\`;
            logEntry.textContent = \`[\${timestamp}] \${message}\`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-area').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        function exportLog() {
            const logContent = document.getElementById('log-area').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = \`web3-debug-\${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt\`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function checkConfiguration() {
            log('å¼€å§‹é…ç½®æ£€æŸ¥...', 'info');
            
            try {
                if (!window.ethereum) {
                    document.getElementById('wallet-connection').innerHTML = '<span class="status-error">æœªå®‰è£… MetaMask</span>';
                    log('æœªæ£€æµ‹åˆ° MetaMask', 'error');
                    return;
                }

                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdDecimal = parseInt(chainId, 16);

                currentAccount = accounts[0] || null;
                
                // æ›´æ–°æ˜¾ç¤º
                if (currentAccount) {
                    document.getElementById('wallet-connection').innerHTML = \`<span class="status-good">å·²è¿æ¥: \${currentAccount.slice(0,6)}...\${currentAccount.slice(-4)}</span>\`;
                } else {
                    document.getElementById('wallet-connection').innerHTML = '<span class="status-warning">æœªè¿æ¥</span>';
                }

                if (chainIdDecimal === CONFIG.MONAD_TESTNET.chainIdDecimal) {
                    document.getElementById('current-chain').innerHTML = \`<span class="status-good">\${chainIdDecimal} âœ“</span>\`;
                    log('ç½‘ç»œé…ç½®æ­£ç¡®', 'success');
                } else {
                    document.getElementById('current-chain').innerHTML = \`<span class="status-error">\${chainIdDecimal} (é”™è¯¯ç½‘ç»œ)</span>\`;
                    log(\`å½“å‰ç½‘ç»œ \${chainIdDecimal} ä¸åŒ¹é…ï¼Œéœ€è¦åˆ‡æ¢åˆ° \${CONFIG.MONAD_TESTNET.chainIdDecimal}\`, 'error');
                }

                // åˆå§‹åŒ– provider
                if (chainIdDecimal === CONFIG.MONAD_TESTNET.chainIdDecimal && currentAccount) {
                    provider = new ethers.BrowserProvider(window.ethereum, {
                        name: 'Monad Testnet',
                        chainId: 10143,
                        ensAddress: null, // ç¦ç”¨ ENS è§£æ
                    });
                    signer = await provider.getSigner();
                    log('Web3 Provider åˆå§‹åŒ–æˆåŠŸ', 'success');
                }

            } catch (error) {
                log(\`é…ç½®æ£€æŸ¥å¤±è´¥: \${error.message}\`, 'error');
            }
        }

        async function connectWallet() {
            log('å¼€å§‹è¿æ¥é’±åŒ…...', 'info');
            
            try {
                if (!window.ethereum) {
                    throw new Error('è¯·å®‰è£… MetaMask');
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (accounts.length === 0) {
                    throw new Error('ç”¨æˆ·æ‹’ç»è¿æ¥');
                }

                currentAccount = accounts[0];
                log(\`é’±åŒ…è¿æ¥æˆåŠŸ: \${currentAccount}\`, 'success');
                await checkConfiguration();

            } catch (error) {
                log(\`é’±åŒ…è¿æ¥å¤±è´¥: \${error.message}\`, 'error');
            }
        }

        async function testRpcConnection() {
            log('æµ‹è¯• RPC è¿æ¥...', 'info');
            
            try {
                const response = await fetch(CONFIG.MONAD_TESTNET.rpcUrls[0], {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_chainId',
                        params: [],
                        id: 1
                    })
                });

                if (!response.ok) {
                    throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(\`RPC é”™è¯¯: \${data.error.message}\`);
                }

                const chainId = parseInt(data.result, 16);
                log(\`RPC è¿æ¥æˆåŠŸ! Chain ID: \${chainId}\`, 'success');
                document.getElementById('network-test-result').innerHTML = \`<span class="status-good">âœ“ RPC è¿æ¥æ­£å¸¸ï¼ŒChain ID: \${chainId}</span>\`;

            } catch (error) {
                log(\`RPC è¿æ¥å¤±è´¥: \${error.message}\`, 'error');
                document.getElementById('network-test-result').innerHTML = \`<span class="status-error">âœ— RPC è¿æ¥å¤±è´¥: \${error.message}</span>\`;
            }
        }

        async function switchToMonadTestnet() {
            log('åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘...', 'info');
            
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CONFIG.MONAD_TESTNET.chainId }]
                });
                
                log('ç½‘ç»œåˆ‡æ¢æˆåŠŸ', 'success');
                setTimeout(checkConfiguration, 1000);

            } catch (error) {
                if (error.code === 4902) {
                    log('ç½‘ç»œæœªæ·»åŠ ï¼Œå°è¯•æ·»åŠ ...', 'warning');
                    await addMonadNetwork();
                } else {
                    log(\`ç½‘ç»œåˆ‡æ¢å¤±è´¥: \${error.message}\`, 'error');
                }
            }
        }

        async function addMonadNetwork() {
            log('æ·»åŠ  Monad æµ‹è¯•ç½‘...', 'info');
            
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [CONFIG.MONAD_TESTNET]
                });
                
                log('ç½‘ç»œæ·»åŠ æˆåŠŸ', 'success');
                setTimeout(checkConfiguration, 1000);

            } catch (error) {
                log(\`ç½‘ç»œæ·»åŠ å¤±è´¥: \${error.message}\`, 'error');
            }
        }

        async function testTokenContract(method) {
            log(\`æµ‹è¯• FMH Token.\${method}()...\`, 'info');
            
            try {
                if (!provider) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶ç¡®ä¿ç½‘ç»œæ­£ç¡®');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.FMH_TOKEN, CONFIG.FMH_TOKEN_ABI, provider);
                const result = await contract[method]();
                
                log(\`\${method}() è°ƒç”¨æˆåŠŸ: \${result}\`, 'success');

            } catch (error) {
                log(\`\${method}() è°ƒç”¨å¤±è´¥: \${error.message}\`, 'error');
            }
        }

        async function testIsOwner() {
            log('æµ‹è¯• isOwner() æ–¹æ³•...', 'info');
            
            try {
                if (!provider || !currentAccount) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.FMH_TOKEN, CONFIG.FMH_TOKEN_ABI, provider);
                const result = await contract.isOwner(currentAccount);
                
                log(\`isOwner(\${currentAccount}) = \${result}\`, 'success');

            } catch (error) {
                log(\`isOwner() è°ƒç”¨å¤±è´¥: \${error.message}\`, 'error');
                log('å¯èƒ½çš„åŸå› : 1) åˆçº¦åœ°å€é”™è¯¯ 2) ABI ä¸åŒ¹é… 3) ç½‘ç»œé—®é¢˜', 'warning');
            }
        }

        async function testTokenBalance() {
            const address = document.getElementById('test-address').value;
            if (!address) {
                log('è¯·è¾“å…¥è¦æŸ¥è¯¢çš„åœ°å€', 'warning');
                return;
            }

            log(\`æŸ¥è¯¢åœ°å€ \${address} çš„ Token ä½™é¢...\`, 'info');
            
            try {
                if (!provider) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶ç¡®ä¿ç½‘ç»œæ­£ç¡®');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.FMH_TOKEN, CONFIG.FMH_TOKEN_ABI, provider);
                const balance = await contract.balanceOf(address);
                const formattedBalance = ethers.utils.formatEther(balance);
                
                log(\`åœ°å€ \${address} çš„ä½™é¢: \${formattedBalance} FMH\`, 'success');

            } catch (error) {
                log(\`ä½™é¢æŸ¥è¯¢å¤±è´¥: \${error.message}\`, 'error');
            }
        }

        async function testGameContract(method) {
            log(\`æµ‹è¯• Minesweeper.\${method}()...\`, 'info');
            
            try {
                if (!provider) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶ç¡®ä¿ç½‘ç»œæ­£ç¡®');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.MINESWEEPER_GAME, CONFIG.GAME_ABI, provider);
                const result = await contract[method]();
                
                log(\`\${method}() è°ƒç”¨æˆåŠŸ: \${result}\`, 'success');

            } catch (error) {
                log(\`\${method}() è°ƒç”¨å¤±è´¥: \${error.message}\`, 'error');
            }
        }

        async function checkGameOwnership() {
            log('æ£€æŸ¥æ¸¸æˆåˆçº¦æ‰€æœ‰æƒ...', 'info');
            
            try {
                if (!provider || !currentAccount) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }

                const contract = new ethers.Contract(CONFIG.CONTRACTS.MINESWEEPER_GAME, CONFIG.GAME_ABI, provider);
                const owner = await contract.owner();
                
                log(\`æ¸¸æˆåˆçº¦ Owner: \${owner}\`, 'success');
                log(\`å½“å‰è´¦æˆ·: \${currentAccount}\`, 'info');
                log(\`æ˜¯å¦ä¸º Owner: \${owner.toLowerCase() === currentAccount.toLowerCase()}\`, 'info');

            } catch (error) {
                log(\`æ‰€æœ‰æƒæ£€æŸ¥å¤±è´¥: \${error.message}\`, 'error');
            }
        }

        async function runFullDiagnostic() {
            log('=== å¼€å§‹å®Œæ•´è¯Šæ–­ ===', 'info');
            
            // åŸºç¡€æ£€æŸ¥
            await checkConfiguration();
            await new Promise(r => setTimeout(r, 1000));
            
            // ç½‘ç»œæµ‹è¯•
            await testRpcConnection();
            await new Promise(r => setTimeout(r, 1000));
            
            // åˆçº¦æµ‹è¯•
            if (provider && currentAccount) {
                await testTokenContract('name');
                await new Promise(r => setTimeout(r, 500));
                await testTokenContract('symbol');
                await new Promise(r => setTimeout(r, 500));
                await testIsOwner();
                await new Promise(r => setTimeout(r, 500));
                await testGameContract('gameCounter');
            }
            
            log('=== è¯Šæ–­å®Œæˆ ===', 'success');
        }

        function fixChainIdMismatch() {
            log('ä¿®å¤ Chain ID ä¸åŒ¹é…é—®é¢˜...', 'info');
            log('æ‰§è¡Œè‡ªåŠ¨åˆ‡æ¢ç½‘ç»œ...', 'warning');
            switchToMonadTestnet();
        }

        function resetWeb3Connection() {
            log('é‡ç½® Web3 è¿æ¥...', 'info');
            provider = null;
            signer = null;
            currentAccount = null;
            log('è¿æ¥å·²é‡ç½®ï¼Œè¯·é‡æ–°è¿æ¥é’±åŒ…', 'success');
        }

        function refreshContractConfig() {
            log('åˆ·æ–°åˆçº¦é…ç½®...', 'info');
            log(\`FMH Token: \${CONFIG.CONTRACTS.FMH_TOKEN}\`, 'info');
            log(\`Minesweeper: \${CONFIG.CONTRACTS.MINESWEEPER_GAME}\`, 'info');
            log(\`Chain ID: \${CONFIG.MONAD_TESTNET.chainIdDecimal}\`, 'info');
            checkConfiguration();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            log('Web3 è°ƒè¯•æ§åˆ¶å°å·²åŠ è½½', 'info');
            checkConfiguration();
        });

        // ç›‘å¬é’±åŒ…äº‹ä»¶
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                currentAccount = accounts[0] || null;
                log(\`è´¦æˆ·å˜æ›´: \${currentAccount || 'æ–­å¼€è¿æ¥'}\`, 'warning');
                checkConfiguration();
            });

            window.ethereum.on('chainChanged', (chainId) => {
                const chainIdDecimal = parseInt(chainId, 16);
                log(\`ç½‘ç»œå˜æ›´: \${chainIdDecimal}\`, 'warning');
                checkConfiguration();
            });
        }
    </script>
</body>
</html>