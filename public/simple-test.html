<!DOCTYPE html>
<html>
<head>
    <title>ç®€å• MetaMask æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .status { padding: 15px; margin: 15px 0; border-radius: 8px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { 
            padding: 15px 30px; 
            margin: 10px; 
            font-size: 18px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            background: #007bff; 
            color: white;
            transition: background 0.3s;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .step { margin: 20px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .code { background: #f1f3f4; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦Š MetaMask è¿æ¥è¯Šæ–­</h1>
        
        <div id="status-container"></div>
        
        <div class="step">
            <h3>æ­¥éª¤ 1: åŸºç¡€æ£€æµ‹</h3>
            <button onclick="step1()">æ£€æµ‹ MetaMask æ˜¯å¦å®‰è£…</button>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤ 2: è¿æ¥æµ‹è¯•</h3>
            <button onclick="step2()">è¯·æ±‚è¿æ¥é’±åŒ…</button>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤ 3: å¼ºåˆ¶è¿æ¥</h3>
            <button onclick="step3()">å¼ºåˆ¶è¯·æ±‚è´¦æˆ·è®¿é—®</button>
        </div>
        
        <div class="step">
            <h3>æµè§ˆå™¨ä¿¡æ¯</h3>
            <div class="code" id="browser-info"></div>
        </div>
        
        <div class="step">
            <h3>æ§åˆ¶å°æ—¥å¿—</h3>
            <div class="code" id="console-log" style="height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px;"></div>
        </div>
    </div>

    <script>
        const statusContainer = document.getElementById('status-container');
        const consoleLog = document.getElementById('console-log');
        
        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            statusContainer.appendChild(div);
            
            // åŒæ—¶è¾“å‡ºåˆ°è‡ªå®šä¹‰æ§åˆ¶å°
            const timestamp = new Date().toLocaleTimeString();
            consoleLog.innerHTML += `[${timestamp}] ${message.replace(/<[^>]*>/g, '')}\n`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
            
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        function updateBrowserInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'Platform': navigator.platform,
                'Language': navigator.language,
                'Cookies Enabled': navigator.cookieEnabled,
                'Online': navigator.onLine,
                'URL': window.location.href,
                'Protocol': window.location.protocol,
                'Window ethereum': typeof window.ethereum,
                'Ethereum isMetaMask': window.ethereum?.isMetaMask,
                'Ethereum chainId': window.ethereum?.chainId,
                'Ethereum selectedAddress': window.ethereum?.selectedAddress
            };
            
            document.getElementById('browser-info').innerHTML = 
                Object.entries(info).map(([key, value]) => `${key}: ${value}`).join('\n');
        }
        
        async function step1() {
            addStatus('ğŸ” å¼€å§‹æ£€æµ‹ MetaMask...', 'info');
            
            if (typeof window.ethereum === 'undefined') {
                addStatus('âŒ <strong>é”™è¯¯</strong>: window.ethereum ä¸å­˜åœ¨<br>è¿™æ„å‘³ç€ MetaMask æˆ–å…¶ä»– Web3 é’±åŒ…æœªå®‰è£…', 'error');
                addStatus('ğŸ’¡ <strong>è§£å†³æ–¹æ¡ˆ</strong>: è¯·å®‰è£… MetaMask æµè§ˆå™¨æ‰©å±•<br>ä¸‹è½½é“¾æ¥: <a href="https://metamask.io/download/" target="_blank">https://metamask.io/download/</a>', 'warning');
                return false;
            }
            
            addStatus('âœ… window.ethereum å­˜åœ¨', 'success');
            
            if (window.ethereum.isMetaMask) {
                addStatus('âœ… ç¡®è®¤æ˜¯ MetaMask é’±åŒ…', 'success');
            } else {
                addStatus('âš ï¸ æ£€æµ‹åˆ°é’±åŒ…ä½†ä¸æ˜¯ MetaMask', 'warning');
            }
            
            if (window.ethereum.selectedAddress) {
                addStatus(`ğŸ“‹ å·²è¿æ¥åœ°å€: ${window.ethereum.selectedAddress}`, 'success');
            } else {
                addStatus('ğŸ“‹ å°šæœªè¿æ¥è´¦æˆ·', 'info');
            }
            
            return true;
        }
        
        async function step2() {
            if (!await step1()) return;
            
            try {
                addStatus('ğŸ” è¯·æ±‚è´¦æˆ·è®¿é—®æƒé™...', 'info');
                addStatus('â³ è¯·åœ¨ MetaMask å¼¹çª—ä¸­ç‚¹å‡» "è¿æ¥"', 'warning');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts && accounts.length > 0) {
                    addStatus(`ğŸ‰ <strong>è¿æ¥æˆåŠŸ!</strong><br>è´¦æˆ·: ${accounts[0]}`, 'success');
                    
                    // è·å–æ›´å¤šä¿¡æ¯
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    addStatus(`ğŸŒ å½“å‰ç½‘ç»œ: ${chainId} (${parseInt(chainId, 16)})`, 'info');
                } else {
                    addStatus('âŒ æœªè·å–åˆ°è´¦æˆ·', 'error');
                }
                
            } catch (error) {
                addStatus(`âŒ <strong>è¿æ¥å¤±è´¥</strong><br>é”™è¯¯: ${error.message}<br>é”™è¯¯ä»£ç : ${error.code}`, 'error');
                
                // å…·ä½“é”™è¯¯å¤„ç†
                if (error.code === 4001) {
                    addStatus('ğŸ’¡ <strong>ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚</strong><br>è¯·é‡è¯•å¹¶åœ¨ MetaMask ä¸­ç‚¹å‡» "è¿æ¥"', 'warning');
                } else if (error.code === -32002) {
                    addStatus('ğŸ’¡ <strong>è¿æ¥è¯·æ±‚å¾…å¤„ç†</strong><br>è¯·æ£€æŸ¥ MetaMask æ‰©å±•å¹¶å®Œæˆè¿æ¥', 'warning');
                }
            }
        }
        
        async function step3() {
            addStatus('ğŸš€ æ‰§è¡Œå¼ºåˆ¶è¿æ¥æµ‹è¯•...', 'info');
            
            // å…ˆæ£€æŸ¥ç°æœ‰è¿æ¥
            try {
                const existingAccounts = await window.ethereum.request({
                    method: 'eth_accounts'
                });
                
                if (existingAccounts.length > 0) {
                    addStatus(`âœ… å‘ç°å·²è¿æ¥è´¦æˆ·: ${existingAccounts[0]}`, 'success');
                    return;
                }
            } catch (error) {
                addStatus(`âš ï¸ æ£€æŸ¥ç°æœ‰è¿æ¥å¤±è´¥: ${error.message}`, 'warning');
            }
            
            // å¼ºåˆ¶è¯·æ±‚è¿æ¥
            try {
                addStatus('âš¡ å¼ºåˆ¶è¯·æ±‚æ–°è¿æ¥...', 'warning');
                
                const result = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                addStatus(`ğŸ¯ å¼ºåˆ¶è¿æ¥ç»“æœ: ${JSON.stringify(result)}`, 'success');
                
            } catch (error) {
                addStatus(`ğŸ’¥ å¼ºåˆ¶è¿æ¥å¤±è´¥: ${error.message} (ä»£ç : ${error.code})`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            addStatus('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ', 'info');
            updateBrowserInfo();
            
            // ç›‘å¬ MetaMask äº‹ä»¶
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    addStatus(`ğŸ”„ è´¦æˆ·å˜åŒ–: ${JSON.stringify(accounts)}`, 'info');
                    updateBrowserInfo();
                });
                
                window.ethereum.on('chainChanged', (chainId) => {
                    addStatus(`ğŸ”„ ç½‘ç»œå˜åŒ–: ${chainId}`, 'info');
                    updateBrowserInfo();
                });
            }
        });
        
        // æ¯5ç§’æ›´æ–°ä¸€æ¬¡æµè§ˆå™¨ä¿¡æ¯
        setInterval(updateBrowserInfo, 5000);
    </script>
</body>
</html>