<!DOCTYPE html>
<html>
<head>
    <title>简单 MetaMask 测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .status { padding: 15px; margin: 15px 0; border-radius: 8px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { 
            padding: 15px 30px; 
            margin: 10px; 
            font-size: 18px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            background: #007bff; 
            color: white;
            transition: background 0.3s;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .step { margin: 20px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .code { background: #f1f3f4; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🦊 MetaMask 连接诊断</h1>
        
        <div id="status-container"></div>
        
        <div class="step">
            <h3>步骤 1: 基础检测</h3>
            <button onclick="step1()">检测 MetaMask 是否安装</button>
        </div>
        
        <div class="step">
            <h3>步骤 2: 连接测试</h3>
            <button onclick="step2()">请求连接钱包</button>
        </div>
        
        <div class="step">
            <h3>步骤 3: 强制连接</h3>
            <button onclick="step3()">强制请求账户访问</button>
        </div>
        
        <div class="step">
            <h3>浏览器信息</h3>
            <div class="code" id="browser-info"></div>
        </div>
        
        <div class="step">
            <h3>控制台日志</h3>
            <div class="code" id="console-log" style="height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px;"></div>
        </div>
    </div>

    <script>
        const statusContainer = document.getElementById('status-container');
        const consoleLog = document.getElementById('console-log');
        
        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            statusContainer.appendChild(div);
            
            // 同时输出到自定义控制台
            const timestamp = new Date().toLocaleTimeString();
            consoleLog.innerHTML += `[${timestamp}] ${message.replace(/<[^>]*>/g, '')}\n`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
            
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        function updateBrowserInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'Platform': navigator.platform,
                'Language': navigator.language,
                'Cookies Enabled': navigator.cookieEnabled,
                'Online': navigator.onLine,
                'URL': window.location.href,
                'Protocol': window.location.protocol,
                'Window ethereum': typeof window.ethereum,
                'Ethereum isMetaMask': window.ethereum?.isMetaMask,
                'Ethereum chainId': window.ethereum?.chainId,
                'Ethereum selectedAddress': window.ethereum?.selectedAddress
            };
            
            document.getElementById('browser-info').innerHTML = 
                Object.entries(info).map(([key, value]) => `${key}: ${value}`).join('\n');
        }
        
        async function step1() {
            addStatus('🔍 开始检测 MetaMask...', 'info');
            
            if (typeof window.ethereum === 'undefined') {
                addStatus('❌ <strong>错误</strong>: window.ethereum 不存在<br>这意味着 MetaMask 或其他 Web3 钱包未安装', 'error');
                addStatus('💡 <strong>解决方案</strong>: 请安装 MetaMask 浏览器扩展<br>下载链接: <a href="https://metamask.io/download/" target="_blank">https://metamask.io/download/</a>', 'warning');
                return false;
            }
            
            addStatus('✅ window.ethereum 存在', 'success');
            
            if (window.ethereum.isMetaMask) {
                addStatus('✅ 确认是 MetaMask 钱包', 'success');
            } else {
                addStatus('⚠️ 检测到钱包但不是 MetaMask', 'warning');
            }
            
            if (window.ethereum.selectedAddress) {
                addStatus(`📋 已连接地址: ${window.ethereum.selectedAddress}`, 'success');
            } else {
                addStatus('📋 尚未连接账户', 'info');
            }
            
            return true;
        }
        
        async function step2() {
            if (!await step1()) return;
            
            try {
                addStatus('🔐 请求账户访问权限...', 'info');
                addStatus('⏳ 请在 MetaMask 弹窗中点击 "连接"', 'warning');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts && accounts.length > 0) {
                    addStatus(`🎉 <strong>连接成功!</strong><br>账户: ${accounts[0]}`, 'success');
                    
                    // 获取更多信息
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    addStatus(`🌐 当前网络: ${chainId} (${parseInt(chainId, 16)})`, 'info');
                } else {
                    addStatus('❌ 未获取到账户', 'error');
                }
                
            } catch (error) {
                addStatus(`❌ <strong>连接失败</strong><br>错误: ${error.message}<br>错误代码: ${error.code}`, 'error');
                
                // 具体错误处理
                if (error.code === 4001) {
                    addStatus('💡 <strong>用户拒绝了连接请求</strong><br>请重试并在 MetaMask 中点击 "连接"', 'warning');
                } else if (error.code === -32002) {
                    addStatus('💡 <strong>连接请求待处理</strong><br>请检查 MetaMask 扩展并完成连接', 'warning');
                }
            }
        }
        
        async function step3() {
            addStatus('🚀 执行强制连接测试...', 'info');
            
            // 先检查现有连接
            try {
                const existingAccounts = await window.ethereum.request({
                    method: 'eth_accounts'
                });
                
                if (existingAccounts.length > 0) {
                    addStatus(`✅ 发现已连接账户: ${existingAccounts[0]}`, 'success');
                    return;
                }
            } catch (error) {
                addStatus(`⚠️ 检查现有连接失败: ${error.message}`, 'warning');
            }
            
            // 强制请求连接
            try {
                addStatus('⚡ 强制请求新连接...', 'warning');
                
                const result = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                addStatus(`🎯 强制连接结果: ${JSON.stringify(result)}`, 'success');
                
            } catch (error) {
                addStatus(`💥 强制连接失败: ${error.message} (代码: ${error.code})`, 'error');
            }
        }
        
        // 页面加载时初始化
        window.addEventListener('load', () => {
            addStatus('🚀 页面加载完成', 'info');
            updateBrowserInfo();
            
            // 监听 MetaMask 事件
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    addStatus(`🔄 账户变化: ${JSON.stringify(accounts)}`, 'info');
                    updateBrowserInfo();
                });
                
                window.ethereum.on('chainChanged', (chainId) => {
                    addStatus(`🔄 网络变化: ${chainId}`, 'info');
                    updateBrowserInfo();
                });
            }
        });
        
        // 每5秒更新一次浏览器信息
        setInterval(updateBrowserInfo, 5000);
    </script>
</body>
</html>