<!DOCTYPE html>
<html>
<head>
    <title>Brave + MetaMask 连接修复</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 12px 24px; margin: 8px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; }
        .primary { background: #007bff; color: white; }
        .secondary { background: #6c757d; color: white; }
        .warning-btn { background: #ffc107; color: #212529; }
        .step { margin: 20px 0; padding: 20px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .code { background: #f1f3f4; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>🦁 Brave + MetaMask 连接修复工具</h1>
    
    <div id="status-container"></div>
    
    <div class="step">
        <h3>🔍 步骤 1: Brave 浏览器检测</h3>
        <button class="primary" onclick="checkBrave()">检测 Brave 浏览器设置</button>
        <p><small>检查 Brave 是否阻止了 MetaMask 连接</small></p>
    </div>
    
    <div class="step">
        <h3>🔧 步骤 2: MetaMask 手动重置</h3>
        <button class="warning-btn" onclick="resetMetaMask()">重置 MetaMask 连接</button>
        <p><small>清除可能的拒绝状态</small></p>
    </div>
    
    <div class="step">
        <h3>🚀 步骤 3: 优化连接流程</h3>
        <button class="primary" onclick="smartConnect()">智能连接</button>
        <button class="secondary" onclick="forceConnect()">强制连接</button>
        <p><small>使用专门针对 Brave 优化的连接方法</small></p>
    </div>
    
    <div class="step">
        <h3>📋 连接状态</h3>
        <div id="connection-status" class="code">等待连接...</div>
    </div>
    
    <div class="step">
        <h3>🛠️ Brave 浏览器解决方案</h3>
        <div class="info">
            <h4>如果连接仍然失败，请尝试：</h4>
            <ol>
                <li><strong>检查 Brave Shields</strong>: 点击地址栏左侧的盾牌图标，确保没有阻止脚本</li>
                <li><strong>禁用广告拦截</strong>: 在 brave://settings/shields 中为 localhost 禁用广告拦截</li>
                <li><strong>允许所有 Cookie</strong>: 在 brave://settings/cookies 中允许第三方 Cookie</li>
                <li><strong>MetaMask 权限重置</strong>: 在 MetaMask 设置中断开并重新连接此网站</li>
                <li><strong>手动连接</strong>: 直接点击 MetaMask 扩展图标，选择"连接网站"</li>
            </ol>
        </div>
    </div>

    <script>
        const statusContainer = document.getElementById('status-container');
        const connectionStatus = document.getElementById('connection-status');
        
        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            statusContainer.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        function updateConnectionStatus(status) {
            connectionStatus.textContent = status;
        }
        
        function checkBrave() {
            addStatus('🔍 检测 Brave 浏览器环境...', 'info');
            
            // 检测 Brave 浏览器
            const isBrave = navigator.brave && navigator.brave.isBrave;
            if (isBrave) {
                addStatus('✅ 确认使用 Brave 浏览器', 'success');
            } else {
                addStatus('⚠️ 无法确认 Brave 浏览器，可能是旧版本', 'warning');
            }
            
            // 检查用户代理
            if (navigator.userAgent.includes('Brave')) {
                addStatus('✅ User Agent 包含 Brave 标识', 'success');
            }
            
            // 检查 MetaMask
            if (window.ethereum) {
                addStatus('✅ MetaMask 已检测到', 'success');
                addStatus(`📍 MetaMask 版本: ${window.ethereum.version || '未知'}`, 'info');
                addStatus(`🔗 已连接账户数: ${window.ethereum.selectedAddress ? '1' : '0'}`, 'info');
            } else {
                addStatus('❌ MetaMask 未检测到', 'error');
            }
            
            // 检查权限
            if (navigator.permissions) {
                navigator.permissions.query({name: 'notifications'}).then(result => {
                    addStatus(`🔔 通知权限: ${result.state}`, 'info');
                });
            }
        }
        
        async function resetMetaMask() {
            addStatus('🔄 重置 MetaMask 连接状态...', 'warning');
            
            if (!window.ethereum) {
                addStatus('❌ MetaMask 不可用', 'error');
                return;
            }
            
            try {
                // 尝试断开连接（如果支持）
                if (window.ethereum.disconnect) {
                    await window.ethereum.disconnect();
                    addStatus('✅ 已断开现有连接', 'success');
                }
                
                // 清除缓存的权限状态
                if (window.ethereum.request) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_revokePermissions',
                            params: [{ eth_accounts: {} }]
                        });
                        addStatus('✅ 已撤销权限', 'success');
                    } catch (e) {
                        addStatus('ℹ️ 权限撤销不可用（这是正常的）', 'info');
                    }
                }
                
                addStatus('✅ 重置完成，请尝试重新连接', 'success');
                
            } catch (error) {
                addStatus(`⚠️ 重置过程中的警告: ${error.message}`, 'warning');
            }
        }
        
        async function smartConnect() {
            addStatus('🚀 开始智能连接流程...', 'info');
            updateConnectionStatus('正在连接...');
            
            if (!window.ethereum) {
                addStatus('❌ MetaMask 不可用', 'error');
                updateConnectionStatus('错误: MetaMask 不可用');
                return;
            }
            
            try {
                // 步骤 1: 检查现有连接
                addStatus('1️⃣ 检查现有账户...', 'info');
                const existingAccounts = await window.ethereum.request({
                    method: 'eth_accounts'
                });
                
                if (existingAccounts.length > 0) {
                    addStatus(`✅ 发现已连接账户: ${existingAccounts[0]}`, 'success');
                    updateConnectionStatus(`已连接: ${existingAccounts[0]}`);
                    return;
                }
                
                // 步骤 2: 延迟请求连接（给 Brave 时间处理）
                addStatus('2️⃣ 准备请求新连接...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 步骤 3: 请求连接
                addStatus('3️⃣ 请求账户访问权限...', 'warning');
                addStatus('👆 <strong>请在 MetaMask 弹窗中点击 "Connect" 或"连接"</strong>', 'warning');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts && accounts.length > 0) {
                    addStatus(`🎉 连接成功! 账户: ${accounts[0]}`, 'success');
                    updateConnectionStatus(`连接成功: ${accounts[0]}`);
                    
                    // 获取网络信息
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    addStatus(`🌐 当前网络: ${chainId} (${parseInt(chainId, 16)})`, 'info');
                } else {
                    addStatus('❌ 未获取到账户', 'error');
                    updateConnectionStatus('错误: 未获取到账户');
                }
                
            } catch (error) {
                let errorMsg = `连接失败: ${error.message}`;
                
                if (error.code === 4001) {
                    errorMsg = '用户拒绝了连接请求';
                    addStatus('❌ ' + errorMsg, 'error');
                    addStatus('💡 <strong>解决方案</strong>: 请点击 MetaMask 扩展图标，手动选择"连接到此网站"', 'warning');
                } else if (error.code === -32002) {
                    errorMsg = '连接请求待处理';
                    addStatus('⏳ ' + errorMsg, 'warning');
                    addStatus('💡 请检查 MetaMask 扩展中是否有待处理的连接请求', 'info');
                } else {
                    addStatus(`❌ ${errorMsg} (代码: ${error.code})`, 'error');
                }
                
                updateConnectionStatus(errorMsg);
            }
        }
        
        async function forceConnect() {
            addStatus('⚡ 强制连接模式...', 'warning');
            
            if (!window.ethereum) {
                addStatus('❌ MetaMask 不可用', 'error');
                return;
            }
            
            try {
                // 直接强制请求
                addStatus('🚨 直接请求连接（忽略缓存）...', 'warning');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                addStatus(`💪 强制连接结果: ${JSON.stringify(accounts)}`, 'success');
                updateConnectionStatus(`强制连接成功: ${accounts[0] || '无账户'}`);
                
            } catch (error) {
                addStatus(`💥 强制连接失败: ${error.message} (代码: ${error.code})`, 'error');
                updateConnectionStatus(`强制连接失败: ${error.message}`);
                
                // 提供 Brave 特定的解决方案
                if (error.code === 4001) {
                    addStatus('🦁 <strong>Brave 浏览器特殊说明</strong>:', 'warning');
                    addStatus('1. 点击地址栏左侧的盾牌图标 🛡️', 'info');
                    addStatus('2. 确保 "脚本已阻止" 显示为 0', 'info');
                    addStatus('3. 如果不是，点击 "关闭" 以禁用脚本阻止', 'info');
                    addStatus('4. 刷新页面并重试', 'info');
                }
            }
        }
        
        // 页面加载时自动检查
        window.addEventListener('load', () => {
            addStatus('🚀 页面加载完成', 'info');
            updateConnectionStatus('就绪');
            
            // 自动检查 Brave
            setTimeout(checkBrave, 500);
        });
        
        // 监听 MetaMask 事件
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                addStatus(`🔄 账户变化: ${JSON.stringify(accounts)}`, 'info');
                updateConnectionStatus(accounts.length > 0 ? `已连接: ${accounts[0]}` : '未连接');
            });
            
            window.ethereum.on('chainChanged', (chainId) => {
                addStatus(`🔄 网络变化: ${chainId} (${parseInt(chainId, 16)})`, 'info');
            });
        }
    </script>
</body>
</html>