<!DOCTYPE html>
<html>
<head>
    <title>Brave + MetaMask è¿æ¥ä¿®å¤</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 12px 24px; margin: 8px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; }
        .primary { background: #007bff; color: white; }
        .secondary { background: #6c757d; color: white; }
        .warning-btn { background: #ffc107; color: #212529; }
        .step { margin: 20px 0; padding: 20px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .code { background: #f1f3f4; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ¦ Brave + MetaMask è¿æ¥ä¿®å¤å·¥å…·</h1>
    
    <div id="status-container"></div>
    
    <div class="step">
        <h3>ğŸ” æ­¥éª¤ 1: Brave æµè§ˆå™¨æ£€æµ‹</h3>
        <button class="primary" onclick="checkBrave()">æ£€æµ‹ Brave æµè§ˆå™¨è®¾ç½®</button>
        <p><small>æ£€æŸ¥ Brave æ˜¯å¦é˜»æ­¢äº† MetaMask è¿æ¥</small></p>
    </div>
    
    <div class="step">
        <h3>ğŸ”§ æ­¥éª¤ 2: MetaMask æ‰‹åŠ¨é‡ç½®</h3>
        <button class="warning-btn" onclick="resetMetaMask()">é‡ç½® MetaMask è¿æ¥</button>
        <p><small>æ¸…é™¤å¯èƒ½çš„æ‹’ç»çŠ¶æ€</small></p>
    </div>
    
    <div class="step">
        <h3>ğŸš€ æ­¥éª¤ 3: ä¼˜åŒ–è¿æ¥æµç¨‹</h3>
        <button class="primary" onclick="smartConnect()">æ™ºèƒ½è¿æ¥</button>
        <button class="secondary" onclick="forceConnect()">å¼ºåˆ¶è¿æ¥</button>
        <p><small>ä½¿ç”¨ä¸“é—¨é’ˆå¯¹ Brave ä¼˜åŒ–çš„è¿æ¥æ–¹æ³•</small></p>
    </div>
    
    <div class="step">
        <h3>ğŸ“‹ è¿æ¥çŠ¶æ€</h3>
        <div id="connection-status" class="code">ç­‰å¾…è¿æ¥...</div>
    </div>
    
    <div class="step">
        <h3>ğŸ› ï¸ Brave æµè§ˆå™¨è§£å†³æ–¹æ¡ˆ</h3>
        <div class="info">
            <h4>å¦‚æœè¿æ¥ä»ç„¶å¤±è´¥ï¼Œè¯·å°è¯•ï¼š</h4>
            <ol>
                <li><strong>æ£€æŸ¥ Brave Shields</strong>: ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„ç›¾ç‰Œå›¾æ ‡ï¼Œç¡®ä¿æ²¡æœ‰é˜»æ­¢è„šæœ¬</li>
                <li><strong>ç¦ç”¨å¹¿å‘Šæ‹¦æˆª</strong>: åœ¨ brave://settings/shields ä¸­ä¸º localhost ç¦ç”¨å¹¿å‘Šæ‹¦æˆª</li>
                <li><strong>å…è®¸æ‰€æœ‰ Cookie</strong>: åœ¨ brave://settings/cookies ä¸­å…è®¸ç¬¬ä¸‰æ–¹ Cookie</li>
                <li><strong>MetaMask æƒé™é‡ç½®</strong>: åœ¨ MetaMask è®¾ç½®ä¸­æ–­å¼€å¹¶é‡æ–°è¿æ¥æ­¤ç½‘ç«™</li>
                <li><strong>æ‰‹åŠ¨è¿æ¥</strong>: ç›´æ¥ç‚¹å‡» MetaMask æ‰©å±•å›¾æ ‡ï¼Œé€‰æ‹©"è¿æ¥ç½‘ç«™"</li>
            </ol>
        </div>
    </div>

    <script>
        const statusContainer = document.getElementById('status-container');
        const connectionStatus = document.getElementById('connection-status');
        
        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            statusContainer.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        function updateConnectionStatus(status) {
            connectionStatus.textContent = status;
        }
        
        function checkBrave() {
            addStatus('ğŸ” æ£€æµ‹ Brave æµè§ˆå™¨ç¯å¢ƒ...', 'info');
            
            // æ£€æµ‹ Brave æµè§ˆå™¨
            const isBrave = navigator.brave && navigator.brave.isBrave;
            if (isBrave) {
                addStatus('âœ… ç¡®è®¤ä½¿ç”¨ Brave æµè§ˆå™¨', 'success');
            } else {
                addStatus('âš ï¸ æ— æ³•ç¡®è®¤ Brave æµè§ˆå™¨ï¼Œå¯èƒ½æ˜¯æ—§ç‰ˆæœ¬', 'warning');
            }
            
            // æ£€æŸ¥ç”¨æˆ·ä»£ç†
            if (navigator.userAgent.includes('Brave')) {
                addStatus('âœ… User Agent åŒ…å« Brave æ ‡è¯†', 'success');
            }
            
            // æ£€æŸ¥ MetaMask
            if (window.ethereum) {
                addStatus('âœ… MetaMask å·²æ£€æµ‹åˆ°', 'success');
                addStatus(`ğŸ“ MetaMask ç‰ˆæœ¬: ${window.ethereum.version || 'æœªçŸ¥'}`, 'info');
                addStatus(`ğŸ”— å·²è¿æ¥è´¦æˆ·æ•°: ${window.ethereum.selectedAddress ? '1' : '0'}`, 'info');
            } else {
                addStatus('âŒ MetaMask æœªæ£€æµ‹åˆ°', 'error');
            }
            
            // æ£€æŸ¥æƒé™
            if (navigator.permissions) {
                navigator.permissions.query({name: 'notifications'}).then(result => {
                    addStatus(`ğŸ”” é€šçŸ¥æƒé™: ${result.state}`, 'info');
                });
            }
        }
        
        async function resetMetaMask() {
            addStatus('ğŸ”„ é‡ç½® MetaMask è¿æ¥çŠ¶æ€...', 'warning');
            
            if (!window.ethereum) {
                addStatus('âŒ MetaMask ä¸å¯ç”¨', 'error');
                return;
            }
            
            try {
                // å°è¯•æ–­å¼€è¿æ¥ï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (window.ethereum.disconnect) {
                    await window.ethereum.disconnect();
                    addStatus('âœ… å·²æ–­å¼€ç°æœ‰è¿æ¥', 'success');
                }
                
                // æ¸…é™¤ç¼“å­˜çš„æƒé™çŠ¶æ€
                if (window.ethereum.request) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_revokePermissions',
                            params: [{ eth_accounts: {} }]
                        });
                        addStatus('âœ… å·²æ’¤é”€æƒé™', 'success');
                    } catch (e) {
                        addStatus('â„¹ï¸ æƒé™æ’¤é”€ä¸å¯ç”¨ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰', 'info');
                    }
                }
                
                addStatus('âœ… é‡ç½®å®Œæˆï¼Œè¯·å°è¯•é‡æ–°è¿æ¥', 'success');
                
            } catch (error) {
                addStatus(`âš ï¸ é‡ç½®è¿‡ç¨‹ä¸­çš„è­¦å‘Š: ${error.message}`, 'warning');
            }
        }
        
        async function smartConnect() {
            addStatus('ğŸš€ å¼€å§‹æ™ºèƒ½è¿æ¥æµç¨‹...', 'info');
            updateConnectionStatus('æ­£åœ¨è¿æ¥...');
            
            if (!window.ethereum) {
                addStatus('âŒ MetaMask ä¸å¯ç”¨', 'error');
                updateConnectionStatus('é”™è¯¯: MetaMask ä¸å¯ç”¨');
                return;
            }
            
            try {
                // æ­¥éª¤ 1: æ£€æŸ¥ç°æœ‰è¿æ¥
                addStatus('1ï¸âƒ£ æ£€æŸ¥ç°æœ‰è´¦æˆ·...', 'info');
                const existingAccounts = await window.ethereum.request({
                    method: 'eth_accounts'
                });
                
                if (existingAccounts.length > 0) {
                    addStatus(`âœ… å‘ç°å·²è¿æ¥è´¦æˆ·: ${existingAccounts[0]}`, 'success');
                    updateConnectionStatus(`å·²è¿æ¥: ${existingAccounts[0]}`);
                    return;
                }
                
                // æ­¥éª¤ 2: å»¶è¿Ÿè¯·æ±‚è¿æ¥ï¼ˆç»™ Brave æ—¶é—´å¤„ç†ï¼‰
                addStatus('2ï¸âƒ£ å‡†å¤‡è¯·æ±‚æ–°è¿æ¥...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ­¥éª¤ 3: è¯·æ±‚è¿æ¥
                addStatus('3ï¸âƒ£ è¯·æ±‚è´¦æˆ·è®¿é—®æƒé™...', 'warning');
                addStatus('ğŸ‘† <strong>è¯·åœ¨ MetaMask å¼¹çª—ä¸­ç‚¹å‡» "Connect" æˆ–"è¿æ¥"</strong>', 'warning');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts && accounts.length > 0) {
                    addStatus(`ğŸ‰ è¿æ¥æˆåŠŸ! è´¦æˆ·: ${accounts[0]}`, 'success');
                    updateConnectionStatus(`è¿æ¥æˆåŠŸ: ${accounts[0]}`);
                    
                    // è·å–ç½‘ç»œä¿¡æ¯
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    addStatus(`ğŸŒ å½“å‰ç½‘ç»œ: ${chainId} (${parseInt(chainId, 16)})`, 'info');
                } else {
                    addStatus('âŒ æœªè·å–åˆ°è´¦æˆ·', 'error');
                    updateConnectionStatus('é”™è¯¯: æœªè·å–åˆ°è´¦æˆ·');
                }
                
            } catch (error) {
                let errorMsg = `è¿æ¥å¤±è´¥: ${error.message}`;
                
                if (error.code === 4001) {
                    errorMsg = 'ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚';
                    addStatus('âŒ ' + errorMsg, 'error');
                    addStatus('ğŸ’¡ <strong>è§£å†³æ–¹æ¡ˆ</strong>: è¯·ç‚¹å‡» MetaMask æ‰©å±•å›¾æ ‡ï¼Œæ‰‹åŠ¨é€‰æ‹©"è¿æ¥åˆ°æ­¤ç½‘ç«™"', 'warning');
                } else if (error.code === -32002) {
                    errorMsg = 'è¿æ¥è¯·æ±‚å¾…å¤„ç†';
                    addStatus('â³ ' + errorMsg, 'warning');
                    addStatus('ğŸ’¡ è¯·æ£€æŸ¥ MetaMask æ‰©å±•ä¸­æ˜¯å¦æœ‰å¾…å¤„ç†çš„è¿æ¥è¯·æ±‚', 'info');
                } else {
                    addStatus(`âŒ ${errorMsg} (ä»£ç : ${error.code})`, 'error');
                }
                
                updateConnectionStatus(errorMsg);
            }
        }
        
        async function forceConnect() {
            addStatus('âš¡ å¼ºåˆ¶è¿æ¥æ¨¡å¼...', 'warning');
            
            if (!window.ethereum) {
                addStatus('âŒ MetaMask ä¸å¯ç”¨', 'error');
                return;
            }
            
            try {
                // ç›´æ¥å¼ºåˆ¶è¯·æ±‚
                addStatus('ğŸš¨ ç›´æ¥è¯·æ±‚è¿æ¥ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰...', 'warning');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                addStatus(`ğŸ’ª å¼ºåˆ¶è¿æ¥ç»“æœ: ${JSON.stringify(accounts)}`, 'success');
                updateConnectionStatus(`å¼ºåˆ¶è¿æ¥æˆåŠŸ: ${accounts[0] || 'æ— è´¦æˆ·'}`);
                
            } catch (error) {
                addStatus(`ğŸ’¥ å¼ºåˆ¶è¿æ¥å¤±è´¥: ${error.message} (ä»£ç : ${error.code})`, 'error');
                updateConnectionStatus(`å¼ºåˆ¶è¿æ¥å¤±è´¥: ${error.message}`);
                
                // æä¾› Brave ç‰¹å®šçš„è§£å†³æ–¹æ¡ˆ
                if (error.code === 4001) {
                    addStatus('ğŸ¦ <strong>Brave æµè§ˆå™¨ç‰¹æ®Šè¯´æ˜</strong>:', 'warning');
                    addStatus('1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„ç›¾ç‰Œå›¾æ ‡ ğŸ›¡ï¸', 'info');
                    addStatus('2. ç¡®ä¿ "è„šæœ¬å·²é˜»æ­¢" æ˜¾ç¤ºä¸º 0', 'info');
                    addStatus('3. å¦‚æœä¸æ˜¯ï¼Œç‚¹å‡» "å…³é—­" ä»¥ç¦ç”¨è„šæœ¬é˜»æ­¢', 'info');
                    addStatus('4. åˆ·æ–°é¡µé¢å¹¶é‡è¯•', 'info');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            addStatus('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ', 'info');
            updateConnectionStatus('å°±ç»ª');
            
            // è‡ªåŠ¨æ£€æŸ¥ Brave
            setTimeout(checkBrave, 500);
        });
        
        // ç›‘å¬ MetaMask äº‹ä»¶
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                addStatus(`ğŸ”„ è´¦æˆ·å˜åŒ–: ${JSON.stringify(accounts)}`, 'info');
                updateConnectionStatus(accounts.length > 0 ? `å·²è¿æ¥: ${accounts[0]}` : 'æœªè¿æ¥');
            });
            
            window.ethereum.on('chainChanged', (chainId) => {
                addStatus(`ğŸ”„ ç½‘ç»œå˜åŒ–: ${chainId} (${parseInt(chainId, 16)})`, 'info');
            });
        }
    </script>
</body>
</html>