<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’±åŒ…è¿æ¥è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #388e3c;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #1976d2;
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .code {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .status:last-child {
            border-bottom: none;
        }
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .green { background: #4CAF50; }
        .red { background: #f44336; }
        .yellow { background: #ff9800; }
    </style>
</head>
<body>
    <h1>ğŸ”§ é’±åŒ…è¿æ¥è¯Šæ–­å·¥å…·</h1>
    
    <div class="section">
        <h2>ğŸ“‹ ç¯å¢ƒæ£€æµ‹</h2>
        <div id="environment-status">
            <div class="status">
                <span><span class="indicator" id="browser-indicator"></span>æµè§ˆå™¨ç¯å¢ƒ</span>
                <span id="browser-status">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status">
                <span><span class="indicator" id="ethereum-indicator"></span>Ethereum å¯¹è±¡</span>
                <span id="ethereum-status">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status">
                <span><span class="indicator" id="metamask-indicator"></span>MetaMask</span>
                <span id="metamask-status">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status">
                <span><span class="indicator" id="network-indicator"></span>ç½‘ç»œè¿æ¥</span>
                <span id="network-status">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ”— é’±åŒ…è¿æ¥æµ‹è¯•</h2>
        <button id="connect-btn" onclick="testWalletConnection()">è¿æ¥é’±åŒ…</button>
        <button id="switch-network-btn" onclick="switchToMonadTestnet()" disabled>åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘</button>
        <button id="get-balance-btn" onclick="getBalance()" disabled>è·å–ä½™é¢</button>
        <div id="connection-result"></div>
    </div>

    <div class="section">
        <h2>ğŸŒ ç½‘ç»œä¿¡æ¯</h2>
        <div id="network-info">
            <div class="status">
                <span>å½“å‰é“¾ID</span>
                <span id="current-chain">æœªè¿æ¥</span>
            </div>
            <div class="status">
                <span>ç›®æ ‡é“¾ID (Monad æµ‹è¯•ç½‘)</span>
                <span>41454</span>
            </div>
            <div class="status">
                <span>è´¦æˆ·åœ°å€</span>
                <span id="account-address">æœªè¿æ¥</span>
            </div>
            <div class="status">
                <span>è´¦æˆ·ä½™é¢</span>
                <span id="account-balance">æœªè·å–</span>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ“ è¯Šæ–­æ—¥å¿—</h2>
        <div id="diagnostic-log" class="code"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <button onclick="downloadLog()">ä¸‹è½½æ—¥å¿—</button>
    </div>

    <script>
        let diagnosticLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            diagnosticLog.push(logEntry);
            
            const logDiv = document.getElementById('diagnostic-log');
            const div = document.createElement('div');
            div.textContent = logEntry;
            if (type === 'error') div.style.color = '#d32f2f';
            if (type === 'success') div.style.color = '#388e3c';
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            diagnosticLog = [];
            document.getElementById('diagnostic-log').innerHTML = '';
        }

        function downloadLog() {
            const logContent = diagnosticLog.join('\n');
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wallet-diagnostic-${new Date().toISOString().slice(0,19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateStatus(elementId, status, isGood) {
            const indicator = document.getElementById(elementId + '-indicator');
            const statusElement = document.getElementById(elementId + '-status');
            
            if (isGood) {
                indicator.className = 'indicator green';
                statusElement.textContent = status;
                statusElement.style.color = '#388e3c';
            } else {
                indicator.className = 'indicator red';
                statusElement.textContent = status;
                statusElement.style.color = '#d32f2f';
            }
        }

        function checkEnvironment() {
            log('å¼€å§‹ç¯å¢ƒæ£€æµ‹...');
            
            // æ£€æŸ¥æµè§ˆå™¨ç¯å¢ƒ
            if (typeof window !== 'undefined') {
                updateStatus('browser', 'âœ“ æµè§ˆå™¨ç¯å¢ƒæ­£å¸¸', true);
                log('âœ“ æµè§ˆå™¨ç¯å¢ƒæ£€æµ‹é€šè¿‡', 'success');
            } else {
                updateStatus('browser', 'âœ— éæµè§ˆå™¨ç¯å¢ƒ', false);
                log('âœ— éæµè§ˆå™¨ç¯å¢ƒ', 'error');
            }

            // æ£€æŸ¥ Ethereum å¯¹è±¡
            if (window.ethereum) {
                updateStatus('ethereum', 'âœ“ Ethereum å¯¹è±¡å­˜åœ¨', true);
                log('âœ“ Ethereum å¯¹è±¡æ£€æµ‹é€šè¿‡', 'success');
                log(`Ethereum æä¾›è€…: ${window.ethereum.constructor.name}`);
            } else {
                updateStatus('ethereum', 'âœ— æœªæ‰¾åˆ° Ethereum å¯¹è±¡', false);
                log('âœ— æœªæ‰¾åˆ° Ethereum å¯¹è±¡', 'error');
            }

            // æ£€æŸ¥ MetaMask
            if (window.ethereum && window.ethereum.isMetaMask) {
                updateStatus('metamask', 'âœ“ MetaMask å·²å®‰è£…', true);
                log('âœ“ MetaMask æ£€æµ‹é€šè¿‡', 'success');
                log(`MetaMask ç‰ˆæœ¬: ${window.ethereum.version || 'æœªçŸ¥'}`);
            } else if (window.ethereum) {
                updateStatus('metamask', 'âš  å…¶ä»–é’±åŒ…', false);
                log('âš  æ£€æµ‹åˆ°å…¶ä»–é’±åŒ…ï¼Œé MetaMask', 'error');
            } else {
                updateStatus('metamask', 'âœ— æœªå®‰è£… MetaMask', false);
                log('âœ— æœªæ£€æµ‹åˆ° MetaMask', 'error');
            }

            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            if (navigator.onLine) {
                updateStatus('network', 'âœ“ ç½‘ç»œè¿æ¥æ­£å¸¸', true);
                log('âœ“ ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
            } else {
                updateStatus('network', 'âœ— ç½‘ç»œè¿æ¥å¼‚å¸¸', false);
                log('âœ— ç½‘ç»œè¿æ¥å¼‚å¸¸', 'error');
            }
        }

        async function testWalletConnection() {
            log('å¼€å§‹é’±åŒ…è¿æ¥æµ‹è¯•...');
            const resultDiv = document.getElementById('connection-result');
            const connectBtn = document.getElementById('connect-btn');
            
            connectBtn.disabled = true;
            connectBtn.textContent = 'è¿æ¥ä¸­...';
            
            try {
                if (!window.ethereum) {
                    throw new Error('æœªæ£€æµ‹åˆ°é’±åŒ…æ‰©å±•');
                }

                log('è¯·æ±‚é’±åŒ…æƒé™...');
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts.length === 0) {
                    throw new Error('ç”¨æˆ·æ‹’ç»è¿æ¥é’±åŒ…');
                }

                const account = accounts[0];
                log(`âœ“ é’±åŒ…è¿æ¥æˆåŠŸ: ${account}`, 'success');
                document.getElementById('account-address').textContent = 
                    `${account.slice(0, 6)}...${account.slice(-4)}`;

                // è·å–é“¾ID
                const chainId = await window.ethereum.request({ 
                    method: 'eth_chainId' 
                });
                const chainIdDecimal = parseInt(chainId, 16);
                log(`å½“å‰é“¾ID: ${chainIdDecimal} (0x${chainIdDecimal.toString(16)})`);
                document.getElementById('current-chain').textContent = chainIdDecimal;

                // æ£€æŸ¥æ˜¯å¦ä¸º Monad æµ‹è¯•ç½‘
                if (chainIdDecimal === 41454) {
                    log('âœ“ å·²è¿æ¥åˆ° Monad æµ‹è¯•ç½‘', 'success');
                    resultDiv.innerHTML = '<div class="success">âœ“ é’±åŒ…è¿æ¥æˆåŠŸï¼Œå·²åœ¨ Monad æµ‹è¯•ç½‘</div>';
                } else {
                    log('âš  å½“å‰ä¸åœ¨ Monad æµ‹è¯•ç½‘', 'error');
                    resultDiv.innerHTML = '<div class="error">âš  é’±åŒ…å·²è¿æ¥ï¼Œä½†éœ€è¦åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘</div>';
                    document.getElementById('switch-network-btn').disabled = false;
                }

                document.getElementById('get-balance-btn').disabled = false;

            } catch (error) {
                log(`âœ— é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">è¿æ¥å¤±è´¥: ${error.message}</div>`;
            } finally {
                connectBtn.disabled = false;
                connectBtn.textContent = 'è¿æ¥é’±åŒ…';
            }
        }

        async function switchToMonadTestnet() {
            log('å°è¯•åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘...');
            
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xa1f6' }], // 41454 in hex
                });
                log('âœ“ æˆåŠŸåˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘', 'success');
                document.getElementById('current-chain').textContent = '41454';
            } catch (switchError) {
                if (switchError.code === 4902) {
                    log('ç½‘ç»œæœªæ·»åŠ ï¼Œå°è¯•æ·»åŠ  Monad æµ‹è¯•ç½‘...');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0xa1f6',
                                chainName: 'Monad Testnet',
                                nativeCurrency: {
                                    name: 'MON',
                                    symbol: 'MON',
                                    decimals: 18
                                },
                                rpcUrls: ['https://testnet-rpc.monad.xyz'],
                                blockExplorerUrls: ['https://testnet-explorer.monad.xyz']
                            }]
                        });
                        log('âœ“ æˆåŠŸæ·»åŠ å¹¶åˆ‡æ¢åˆ° Monad æµ‹è¯•ç½‘', 'success');
                        document.getElementById('current-chain').textContent = '41454';
                    } catch (addError) {
                        log(`âœ— æ·»åŠ ç½‘ç»œå¤±è´¥: ${addError.message}`, 'error');
                    }
                } else {
                    log(`âœ— åˆ‡æ¢ç½‘ç»œå¤±è´¥: ${switchError.message}`, 'error');
                }
            }
        }

        async function getBalance() {
            log('è·å–è´¦æˆ·ä½™é¢...');
            
            try {
                const accounts = await window.ethereum.request({ 
                    method: 'eth_accounts' 
                });
                
                if (accounts.length === 0) {
                    throw new Error('æœªè¿æ¥é’±åŒ…');
                }

                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [accounts[0], 'latest']
                });

                const balanceInEth = parseInt(balance, 16) / Math.pow(10, 18);
                log(`è´¦æˆ·ä½™é¢: ${balanceInEth} MON`);
                document.getElementById('account-balance').textContent = 
                    `${balanceInEth.toFixed(4)} MON`;

            } catch (error) {
                log(`âœ— è·å–ä½™é¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œç¯å¢ƒæ£€æµ‹
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è¯Šæ–­...');
            checkEnvironment();
        });

        // ç›‘å¬é’±åŒ…äº‹ä»¶
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                log(`è´¦æˆ·å˜æ›´: ${accounts[0] || 'æ— è´¦æˆ·'}`);
                if (accounts.length > 0) {
                    document.getElementById('account-address').textContent = 
                        `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                } else {
                    document.getElementById('account-address').textContent = 'æœªè¿æ¥';
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                const chainIdDecimal = parseInt(chainId, 16);
                log(`ç½‘ç»œå˜æ›´: ${chainIdDecimal}`);
                document.getElementById('current-chain').textContent = chainIdDecimal;
            });
        }
    </script>
</body>
</html>