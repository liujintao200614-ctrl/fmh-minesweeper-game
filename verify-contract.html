<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合约地址验证工具</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .input-group { margin: 20px 0; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; }
        .input-group input:focus { outline: none; border-color: #007bff; }
        .btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .result { margin: 20px 0; padding: 15px; border-radius: 8px; border-left: 4px solid; }
        .result.success { background: #d4edda; color: #155724; border-color: #28a745; }
        .result.error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        .result.info { background: #d1ecf1; color: #0c5460; border-color: #17a2b8; }
        .contract-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .contract-info h4 { margin: 0 0 10px 0; color: #495057; }
        .function-list { max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 FMH合约地址验证工具</h1>
        <p>验证合约地址是否正确，检查合约函数和网络连接状态</p>
        
        <div class="input-group">
            <label for="contractAddress">合约地址:</label>
            <input type="text" id="contractAddress" placeholder="输入合约地址 (0x...)" value="0xFa32A01E4FDAde90204902EDfEa63C150407C736">
        </div>
        
        <div>
            <button class="btn" onclick="verifyContract()">🔍 验证合约</button>
            <button class="btn btn-success" onclick="connectWallet()">🔗 连接钱包</button>
            <button class="btn btn-danger" onclick="clearResults()">🧹 清除结果</button>
        </div>
        
        <div id="walletStatus"></div>
        <div id="verificationResult"></div>
    </div>

    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        let provider, signer, userAddress;
        const MONAD_CHAIN_ID = "0x279F";
        
        function showResult(elementId, type, message) {
            document.getElementById(elementId).innerHTML = `<div class="result ${type}">${message}</div>`;
        }
        
        function clearResults() {
            document.getElementById('verificationResult').innerHTML = '';
            document.getElementById('walletStatus').innerHTML = '';
        }
        
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showResult('walletStatus', 'error', '❌ MetaMask未安装');
                    return;
                }
                
                showResult('walletStatus', 'info', '⏳ 正在连接钱包...');
                
                // 请求连接
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // 检查网络
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== MONAD_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: MONAD_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: MONAD_CHAIN_ID,
                                    chainName: 'Monad Testnet',
                                    nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
                                    rpcUrls: ['https://testnet-rpc.monad.xyz'],
                                    blockExplorerUrls: ['https://testnet-explorer.monad.xyz']
                                }]
                            });
                        }
                    }
                }
                
                provider = new ethers.BrowserProvider(window.ethereum, {
                    name: 'Monad Testnet',
                    chainId: 10143,
                    ensAddress: null, // 禁用 ENS 解析
                });
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                showResult('walletStatus', 'success', `✅ 钱包连接成功<br><strong>地址:</strong> ${userAddress}<br><strong>网络:</strong> Monad测试网`);
                
            } catch (error) {
                showResult('walletStatus', 'error', `❌ 连接失败: ${error.message}`);
            }
        }
        
        async function verifyContract() {
            const contractAddress = document.getElementById('contractAddress').value.trim();
            
            if (!contractAddress) {
                showResult('verificationResult', 'error', '❌ 请输入合约地址');
                return;
            }
            
            if (!ethers.utils.isAddress(contractAddress)) {
                showResult('verificationResult', 'error', '❌ 合约地址格式错误');
                return;
            }
            
            if (!provider) {
                showResult('verificationResult', 'error', '❌ 请先连接钱包');
                return;
            }
            
            showResult('verificationResult', 'info', '⏳ 正在验证合约...');
            
            try {
                let resultHTML = `<div class="contract-info">`;
                resultHTML += `<h4>📋 合约验证结果</h4>`;
                resultHTML += `<strong>地址:</strong> ${contractAddress}<br>`;
                
                // 1. 检查地址是否是合约
                const code = await provider.getCode(contractAddress);
                if (code === '0x') {
                    showResult('verificationResult', 'error', `❌ 地址不是合约<br>这个地址没有部署任何合约代码`);
                    return;
                }
                
                resultHTML += `<strong>合约代码:</strong> ✅ 存在 (${code.length} 字节)<br>`;
                
                // 2. 测试ERC20基础函数
                const erc20ABI = [
                    "function name() view returns (string)",
                    "function symbol() view returns (string)", 
                    "function decimals() view returns (uint8)",
                    "function totalSupply() view returns (uint256)",
                    "function balanceOf(address) view returns (uint256)"
                ];
                
                const contract = new ethers.Contract(contractAddress, erc20ABI, provider);
                
                try {
                    const name = await contract.name();
                    resultHTML += `<strong>代币名称:</strong> ${name}<br>`;
                } catch (e) {
                    resultHTML += `<strong>代币名称:</strong> ❌ 无法获取 (${e.message})<br>`;
                }
                
                try {
                    const symbol = await contract.symbol();
                    resultHTML += `<strong>代币符号:</strong> ${symbol}<br>`;
                } catch (e) {
                    resultHTML += `<strong>代币符号:</strong> ❌ 无法获取<br>`;
                }
                
                try {
                    const decimals = await contract.decimals();
                    resultHTML += `<strong>小数位数:</strong> ${decimals}<br>`;
                } catch (e) {
                    resultHTML += `<strong>小数位数:</strong> ❌ 无法获取<br>`;
                }
                
                try {
                    const totalSupply = await contract.totalSupply();
                    resultHTML += `<strong>总供应量:</strong> ${ethers.utils.formatEther(totalSupply)}<br>`;
                } catch (e) {
                    resultHTML += `<strong>总供应量:</strong> ❌ 无法获取<br>`;
                }
                
                // 3. 测试FMH特有函数
                const fmhABI = [
                    "function isOwner(address) view returns (bool)",
                    "function isAuthorizedMinter(address) view returns (bool)",
                    "function getRemainingSupply() view returns (uint256)",
                    "function getTotalBurned() view returns (uint256)",
                    "function minesweeperGame() view returns (address)"
                ];
                
                const fmhContract = new ethers.Contract(contractAddress, fmhABI, provider);
                
                try {
                    const remainingSupply = await fmhContract.getRemainingSupply();
                    resultHTML += `<strong>剩余供应量:</strong> ${ethers.utils.formatEther(remainingSupply)}<br>`;
                } catch (e) {
                    resultHTML += `<strong>剩余供应量:</strong> ❌ 不是FMH合约或函数不存在<br>`;
                }
                
                if (userAddress) {
                    try {
                        const isOwner = await fmhContract.isOwner(userAddress);
                        const isMinter = await fmhContract.isAuthorizedMinter(userAddress);
                        resultHTML += `<strong>当前用户权限:</strong><br>`;
                        resultHTML += `&nbsp;&nbsp;Owner: ${isOwner ? '✅ 是' : '❌ 否'}<br>`;
                        resultHTML += `&nbsp;&nbsp;Minter: ${isMinter ? '✅ 是' : '❌ 否'}<br>`;
                    } catch (e) {
                        resultHTML += `<strong>权限检查:</strong> ❌ 无法检查<br>`;
                    }
                }
                
                // 4. 网络信息
                const chainIdHex = await provider.send('eth_chainId', []);
                const chainId = parseInt(chainIdHex, 16);
                resultHTML += `<strong>网络信息:</strong><br>`;
                resultHTML += `&nbsp;&nbsp;Chain ID: ${chainId}<br>`;
                resultHTML += `&nbsp;&nbsp;网络名称: Monad Testnet<br>`;
                
                resultHTML += `</div>`;
                
                // 5. 测试建议
                resultHTML += `<div class="contract-info">`;
                resultHTML += `<h4>💡 测试建议</h4>`;
                if (code !== '0x') {
                    resultHTML += `✅ 合约地址有效，可以使用<br>`;
                    resultHTML += `✅ 建议在管理面板中使用此地址<br>`;
                } else {
                    resultHTML += `❌ 合约地址无效，请检查<br>`;
                }
                resultHTML += `</div>`;
                
                showResult('verificationResult', 'success', resultHTML);
                
            } catch (error) {
                console.error('验证失败:', error);
                let errorMsg = `❌ 合约验证失败:<br><br>`;
                errorMsg += `<strong>错误类型:</strong> ${error.code || 'Unknown'}<br>`;
                errorMsg += `<strong>错误信息:</strong> ${error.message}<br><br>`;
                
                errorMsg += `<strong>可能原因:</strong><br>`;
                errorMsg += `• 合约地址不存在<br>`;
                errorMsg += `• 网络连接问题<br>`;
                errorMsg += `• RPC节点响应异常<br>`;
                errorMsg += `• 合约不是ERC20代币<br><br>`;
                
                errorMsg += `<strong>解决建议:</strong><br>`;
                errorMsg += `• 检查合约地址是否正确<br>`;
                errorMsg += `• 确认在正确的网络（Monad测试网）<br>`;
                errorMsg += `• 尝试刷新页面重新连接<br>`;
                errorMsg += `• 在区块浏览器中查看合约`;
                
                showResult('verificationResult', 'error', errorMsg);
            }
        }
        
        // 页面加载时自动连接（如果已经连接过）
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.selectedAddress) {
                try {
                    await connectWallet();
                } catch (error) {
                    console.log('自动连接失败');
                }
            }
        });
    </script>
</body>
</html>